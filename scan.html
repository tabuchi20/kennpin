<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>バーコードスキャナー</title>
<style>
    video {
        width: 100%;
        max-width: 400px;
        border: 2px solid black;
        border-radius: 10px;
    }

    #scan-frame {
        width: 220px;
        height: 220px;
        border: 3px solid red;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        pointer-events: none;
    }

    #output {
        margin-top: 15px;
        font-size: 18px;
        font-weight: bold;
    }
</style>
</head>

<body>

<h2>バーコード読み取り</h2>

<div style="position: relative; width:400px;">
    <video id="camera" autoplay playsinline></video>
    <div id="scan-frame"></div>
</div>

<br>
<button id="exportBtn" disabled>CSV出力</button>
<div id="output">読み取り結果：なし</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
const video = document.getElementById("camera");
const outputDiv = document.getElementById("output");
const scanFrame = document.getElementById("scan-frame");
const exportBtn = document.getElementById("exportBtn");

const reader = new ZXing.BrowserMultiFormatReader();
let results = [];
let scanning = true;

// ====== CSV出力 ======
exportBtn.addEventListener("click", () => {
    const csvContent = "data:text/csv;charset=utf-8," +
        results.map(row => row).join("\n");

    const link = document.createElement("a");
    link.href = encodeURI(csvContent);
    link.download = "barcode_results.csv";
    link.click();
});

async function startCamera() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: "environment",
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        });

        video.srcObject = stream;
        video.onloadedmetadata = () => video.play();

        startScanning();
    } catch (err) {
        alert("カメラが使用できません: " + err);
    }
}

function startScanning() {
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    async function scanLoop() {
        if (!scanning) return;

        canvas.width = scanFrame.offsetWidth;
        canvas.height = scanFrame.offsetHeight;

        const videoRect = video.getBoundingClientRect();
        const frameRect = scanFrame.getBoundingClientRect();

        const sx = (frameRect.left - videoRect.left) * (video.videoWidth / videoRect.width);
        const sy = (frameRect.top - videoRect.top) * (video.videoHeight / videoRect.height);
        const sWidth = canvas.width * (video.videoWidth / videoRect.width);
        const sHeight = canvas.height * (video.videoHeight / videoRect.height);

        ctx.drawImage(video, sx, sy, sWidth, sHeight, 0, 0, canvas.width, canvas.height);

        try {
            const result = await reader.decodeFromImageUrl(canvas.toDataURL());
            if (result && result.text) {
                addResult(result.text);
            }
        } catch {}

        requestAnimationFrame(scanLoop);
    }

    scanLoop();
}

function addResult(code) {
    if (!results.includes(code)) {
        results.push(code);
        exportBtn.disabled = false;
    }
    outputDiv.textContent = "読み取り結果：" + code;
}

startCamera();
</script>

</body>
</html>
