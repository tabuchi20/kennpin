<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>æµ·å¤–ãƒ©ãƒ™ãƒ«è²¼ã‚Šæ¤œå“</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont;
  padding:20px;
  margin-bottom:90px;
}
#status {
  padding:20px;
  font-size:22px;
  font-weight:bold;
  border-radius:12px;
  text-align:center;
}
.ok { background:#2ecc71; color:#fff; }
.ng { background:#e74c3c; color:#fff; }
.normal { background:#eee; color:#0066cc; }

video {
  width:100%;
  max-width:400px;
  border-radius:10px;
  margin:auto;
  display:block;
}

button {
  width:100%;
  padding:15px;
  font-size:18px;
  margin-top:15px;
  border-radius:10px;
}

.navbar {
  position:fixed;
  bottom:0; left:0;
  width:100%;
  display:flex;
  background:#f3f3f3;
  border-top:2px solid #ccc;
}
.navbar a {
  flex:1;
  text-align:center;
  padding:15px 0;
  text-decoration:none;
  color:#333;
}
.navbar a.active {
  background:#0078ff;
  color:white;
  font-weight:bold;
}
</style>
</head>

<body>

<h2>æµ·å¤–ãƒ©ãƒ™ãƒ«è²¼ã‚Šæ¤œå“</h2>

<div id="status" class="normal">
æµ·å¤–ãƒ‘ãƒ¼ãƒ„ãƒ©ãƒ™ãƒ«ã®å“ç•ªã‚’èª­ã¿å–ã£ã¦ãã ã•ã„
</div>

<video id="video" playsinline></video>

<button id="scanBtn">ğŸ“· èª­ã¿å–ã‚Šé–‹å§‹</button>
<button id="resetBtn">ğŸ”„ æœ€åˆã«æˆ»ã‚‹</button>

<div class="navbar">
  <a href="index.html">ğŸ“· QRæ¤œå“</a>
  <a href="tenyuryoku.html">âŒ¨ æ‰‹å…¥åŠ›</a>
  <a href="scan.html" class="active">ğŸ·ï¸ æµ·å¤–ãƒ©ãƒ™ãƒ«</a>
</div>

<!-- â˜… å®Œå…¨ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ ZXing -->
<script src="js/zxing.min.js"></script>

<script>
const video = document.getElementById("video");
const scanBtn = document.getElementById("scanBtn");
const resetBtn = document.getElementById("resetBtn");

let step = 1;
let firstCode = "";
let controls = null;

const reader = new ZXing.BrowserMultiFormatReader();

function setStatus(text, type="normal") {
  const s = document.getElementById("status");
  s.textContent = text;
  s.className = type;
}

async function startScan() {
  try {
    controls = await reader.decodeFromVideoDevice(
      null,
      video,
      (result, err) => {
        if (result) {
          handleScan(result.text);
        }
      }
    );
  } catch (e) {
    alert("ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—: " + e.message);
  }
}

function stopScan() {
  if (controls) {
    controls.stop();
    controls = null;
  }
}

function handleScan(code) {
  stopScan();
  const value = code.trim();

  if (step === 1) {
    if (value.length > 7) {
      setStatus("âŒ 7æ–‡å­—ä»¥ä¸‹ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„", "ng");
      return;
    }
    firstCode = value;
    step = 2;
    setStatus("æ¬¡ã«è²¼ä»˜ãƒ©ãƒ™ãƒ«ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„", "normal");
    return;
  }

  if (step === 2) {
    const ok = value.includes(firstCode);
    setStatus(ok ? "âœ” ä¸€è‡´ã—ã¾ã—ãŸ" : "âŒ ä¸ä¸€è‡´ã§ã™", ok ? "ok" : "ng");
    step = 3;
  }
}

function resetAll() {
  stopScan();
  step = 1;
  firstCode = "";
  setStatus("æµ·å¤–ãƒ‘ãƒ¼ãƒ„ãƒ©ãƒ™ãƒ«ã®å“ç•ªã‚’èª­ã¿å–ã£ã¦ãã ã•ã„", "normal");
}

scanBtn.onclick = startScan;
resetBtn.onclick = resetAll;
</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
