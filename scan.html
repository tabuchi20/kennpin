<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>バーコードスキャナー（2回照合）</title>
<style>
    video {
        width: 100%;
        max-width: 400px;
        border: 2px solid black;
        border-radius: 10px;
    }

    #scan-frame {
        width: 220px;
        height: 220px;
        border: 3px solid red;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        pointer-events: none;
    }

    #output {
        margin-top: 15px;
        font-size: 18px;
        font-weight: bold;
    }
</style>
</head>

<body>

<h2>バーコード読み取り（2回照合）</h2>

<div style="position: relative; width:400px;">
    <video id="camera" autoplay playsinline></video>
    <div id="scan-frame"></div>
</div>

<br>
<button id="resetBtn">リセット</button>
<div id="output">読み取り結果：なし</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
const video = document.getElementById("camera");
const outputDiv = document.getElementById("output");
const scanFrame = document.getElementById("scan-frame");
const resetBtn = document.getElementById("resetBtn");

const reader = new ZXing.BrowserMultiFormatReader({
    // バーコード優先
    possibleFormats: [
        ZXing.BarcodeFormat.CODE_128,
        ZXing.BarcodeFormat.CODE_39,
        ZXing.BarcodeFormat.EAN_13,
        ZXing.BarcodeFormat.EAN_8
    ]
});

let firstScan = null;
let secondScan = null;
let scanning = true;

resetBtn.addEventListener("click", () => {
    firstScan = null;
    secondScan = null;
    outputDiv.textContent = "読み取り結果：リセット済み";
});

// ====== カメラ起動 ======
async function startCamera() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: "environment",
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        });

        video.srcObject = stream;
        video.onloadedmetadata = () => video.play();

        startScanning();
    } catch (err) {
        alert("カメラが使用できません: " + err);
    }
}

// ====== 読み取りループ ======
function startScanning() {
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    async function scanLoop() {
        if (!scanning) return;

        canvas.width = scanFrame.offsetWidth;
        canvas.height = scanFrame.offsetHeight;

        const videoRect = video.getBoundingClientRect();
        const frameRect = scanFrame.getBoundingClientRect();

        const sx = (frameRect.left - videoRect.left) * (video.videoWidth / videoRect.width);
        const sy = (frameRect.top - videoRect.top) * (video.videoHeight / videoRect.height);
        const sWidth = canvas.width * (video.videoWidth / videoRect.width);
        const sHeight = canvas.height * (video.videoHeight / videoRect.height);

        ctx.drawImage(video, sx, sy, sWidth, sHeight, 0, 0, canvas.width, canvas.height);

        try {
            const result = await reader.decodeFromImageUrl(canvas.toDataURL());
            if (result && result.text) {
                processScan(result.text);
            }
        } catch {}

        requestAnimationFrame(scanLoop);
    }

    scanLoop();
}

// ====== 読み取り結果処理（2回照合） ======
function processScan(code) {
    // 1回目の読み取り
    if (!firstScan) {
        firstScan = code;
        outputDiv.textContent = "1回目読み取り：" + code;
        return;
    }

    // 2回目の読み取り
    if (!secondScan) {
        secondScan = code;

        if (firstScan === secondScan) {
            outputDiv.textContent =
                `判定：一致 ✔（${firstScan}）`;
        } else {
            outputDiv.textContent =
                `判定：不一致 ✖（1回目: ${firstScan} / 2回目: ${secondScan}）`;
        }
        return;
    }
}

startCamera();
</script>

</body>
</html>
