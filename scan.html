<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>æµ·å¤–ãƒ©ãƒ™ãƒ«è²¼ã‚Šæ¤œå“</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: -apple-system, BlinkMacSystemFont; padding: 20px; margin-bottom:80px; }
#status { padding: 20px; font-size: 24px; font-weight: bold; border-radius: 12px; text-align: center; margin-bottom: 10px; }
.ok { background: green; color: white; }
.ng { background: red; color: white; }
.normal { background: #e5e5e5; color: #0066cc; }

#firstCodeDisplay {
    font-size: 20px;
    margin-bottom: 20px;
    color: #333;
    font-weight: bold;
}

#video-container { position: relative; width: 100%; max-width: 400px; margin: auto; }
video { width: 100%; border-radius: 10px; }

#scan-frame {
  width: 260px;
  height: 160px;
  border: 3px solid rgba(255,0,0,0.8);
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
  border-radius: 10px;
}

button { width: 100%; font-size: 20px; padding: 15px; margin-top: 20px; border-radius: 10px; }

table { width: 100%; margin-top: 20px; border-collapse: collapse; }
th, td { border-bottom: 1px solid #ddd; padding: 8px; }

    /* ===== å…±é€šãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ ===== */
.navbar {
    position:fixed;
    bottom:0;
    left:0;
    width:100%;
    background:#f3f3f3;
    border-top:2px solid #ccc;
    display:flex;
    justify-content:space-around;
    z-index:9999;
}
.navbar a {
    flex:1;
    text-align:center;
    padding:15px 0;
    font-size:18px;
    text-decoration:none;
    color:#333;
}
.navbar a.active {
    background:#0078ff;
    color:white;
    font-weight:bold;
}
    
</style>
</head>

<body>

<h2>æµ·å¤–ãƒ©ãƒ™ãƒ«è²¼ã‚Šæ¤œå“</h2>

<div id="status" class="normal">æµ·å¤–ãƒ‘ãƒ¼ãƒ„ãƒ©ãƒ™ãƒ«ã®å“ç•ªã‚’èª­ã¿å–ã£ã¦ãã ã•ã„</div>

<div id="firstCodeDisplay"></div>

<div id="video-container">
    <video id="v" autoplay playsinline></video>
    <div id="scan-frame"></div>
</div>

<button id="scanBtn">ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹</button>
<button id="resetBtn">ğŸ”„ æœ€åˆã«æˆ»ã‚‹</button>
<button id="csvBtn">ğŸ“„ CSVå‡ºåŠ›</button>

<h3>å±¥æ­´ï¼ˆæœ€æ–°5ä»¶ï¼‰</h3>
<table id="history"></table>

    <!-- â–¼ ãƒ•ãƒƒã‚¿ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
<div class="navbar">
    <a href="index.html">ğŸ“· QRæ¤œå“</a>
    <a href="tenyuryoku.html">âŒ¨ æ‰‹å…¥åŠ›æ¤œå“</a>
  ã€€<a href="scan.html" class="active">ğŸ·ï¸ æµ·å¤–ãƒ©ãƒ™ãƒ«</a>
</div>

<script src="https://unpkg.com/@zxing/library@latest"></script>

<script>
// ========== éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ« ==========
const readSound = new Audio("sounds/yomitori.mp3");
const successSound = new Audio("sounds/seikou.mp3");
const errorSound = new Audio("sounds/keikoku.mp3");

// ========== ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ ==========
function vibrate(pattern) {
    if (navigator.vibrate) navigator.vibrate(pattern);
}

// ========== å¤‰æ•° ==========
let step = 1;
let firstCode = "";
let secondCode = "";
let scanning = false;

const reader = new ZXing.BrowserMultiFormatReader();
const video = document.getElementById("v");
const scanFrame = document.getElementById("scan-frame");

// ========== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º ==========
function setStatus(text, type="normal") {
    const s = document.getElementById("status");
    s.textContent = text;
    s.className = type;
}

// ========== ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ ==========
async function startScan() {
    if (scanning) return;
    scanning = true;

    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: "environment",
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        });

        video.srcObject = stream;
        scanLoop();
    } catch (e) {
        alert("ã‚«ãƒ¡ãƒ©ãŒä½¿ç”¨ã§ãã¾ã›ã‚“ï¼š" + e.message);
        scanning = false;
    }
}

// ========== ã‚¹ã‚­ãƒ£ãƒ³ãƒ«ãƒ¼ãƒ— ==========
async function scanLoop() {
    if (!scanning) return;

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    const frameRect = scanFrame.getBoundingClientRect();
    const videoRect = video.getBoundingClientRect();

    canvas.width = frameRect.width;
    canvas.height = frameRect.height;

    const scaleX = video.videoWidth / videoRect.width;
    const scaleY = video.videoHeight / videoRect.height;

    ctx.drawImage(
        video,
        (frameRect.left - videoRect.left) * scaleX,
        (frameRect.top  - videoRect.top ) * scaleY,
        frameRect.width  * scaleX,
        frameRect.height * scaleY,
        0, 0, canvas.width, canvas.height
    );

    try {
        const result = await reader.decodeFromImageUrl(canvas.toDataURL());
        if (result && result.text) {
            handleScan(result.text);
            return;
        }
    } catch (e) { }

    requestAnimationFrame(scanLoop);
}

// ========== ã‚«ãƒ¡ãƒ©åœæ­¢ ==========
function stopCamera() {
    scanning = false;
    if (video.srcObject) {
        video.srcObject.getTracks().forEach(t => t.stop());
    }
    video.srcObject = null;
}

// ========== ã‚¹ã‚­ãƒ£ãƒ³å¾Œå‡¦ç† ==========
function handleScan(code) {
    stopCamera();

    const scanned = code.trim();

    // èª­ã¿å–ã‚ŠéŸ³
    readSound.currentTime = 0;
    readSound.play();
    vibrate(150);

    // ======== 1å›ç›®ï¼ˆ7æ–‡å­—ä»¥ä¸‹ï¼‰========
    if (step === 1) {
        if (scanned.length > 7) {
            errorSound.play();
            vibrate([200,100,200]);
            setStatus("âŒ 1å›ç›®ã¯7æ–‡å­—ä»¥ä¸‹ã§èª­ã¿å–ã£ã¦ãã ã•ã„", "ng");
            return;
        }

        firstCode = scanned;

        document.getElementById("firstCodeDisplay").textContent =
            "1å›ç›®ã®ã‚³ãƒ¼ãƒ‰ : " + firstCode;

        setStatus("æµ·å¤–ãƒ‘ãƒ¼ãƒ„ãƒ©ãƒ™ãƒ«ã®å“ç•ªã‚’èª­ã¿å–ã£ã¦ãã ã•ã„", "normal");
        step = 2;
        return;
    }

    // ======== 2å›ç›®ï¼ˆ8æ–‡å­—ä»¥ä¸Šï¼‰========
    if (step === 2) {
        if (scanned.length < 8) {
            errorSound.play();
            vibrate([200,100,200]);
            setStatus("âŒ 2å›ç›®ã¯8æ–‡å­—ä»¥ä¸Šã‚’èª­ã¿å–ã£ã¦ãã ã•ã„", "ng");
            return;
        }

        secondCode = scanned;

        // â˜… å«ã¾ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã®åˆ¤å®š
        const ok = secondCode.includes(firstCode);

        if (ok) {
            successSound.play();
            vibrate([200, 100, 200]);
            setStatus("âœ” ä¸€è‡´ã—ã¾ã—ãŸï¼", "ok");
        } else {
            errorSound.play();
            vibrate([300, 120, 300]);
            setStatus("âŒ ä¸ä¸€è‡´ã§ã™", "ng");
        }

        addHistory(firstCode, secondCode, ok ? "OK" : "NG");

        // ã‚¹ã‚­ãƒ£ãƒ³ãƒœã‚¿ãƒ³ã‚’éš ã™
        document.getElementById("scanBtn").style.display = "none";

        step = 3;
        return;
    }
}

// ========== æœ€åˆã«æˆ»ã‚‹ ==========
function resetAll() {
    step = 1;
    firstCode = "";
    secondCode = "";

    setStatus("æµ·å¤–ãƒ‘ãƒ¼ãƒ„ãƒ©ãƒ™ãƒ«ã®å“ç•ªã‚’èª­ã¿å–ã£ã¦ãã ã•ã„", "normal");
    document.getElementById("firstCodeDisplay").textContent = "";
    document.getElementById("scanBtn").style.display = "block";
}

// ========== å±¥æ­´ ==========
function loadHistory() {
  const tx = db.transaction("records","readonly");
  const req = tx.objectStore("records").getAll();

  req.onsuccess = () => {
    const table = document.getElementById("history");
    table.innerHTML = "<tr><th>æ™‚åˆ»</th><th>1å›ç›®</th><th>2å›ç›®</th><th>çµæœ</th></tr>";

    req.result
      .reverse()
      .slice(0,5)
      .forEach(r=>{
        table.innerHTML += `
          <tr>
            <td>${r.time}</td>
            <td>${r.first}</td>
            <td>${r.scanned}</td>
            <td>${r.result}</td>
          </tr>
        `;
      });
  };
}

// ========== CSV å‡ºåŠ› ==========
function downloadCSV() {
    let csv = "æ™‚åˆ»,1å›ç›®,2å›ç›®,çµæœ\n";
    historyData.forEach(row => {
        csv += `${row.time},${row.first},${row.second},${row.result}\n`;
    });

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "barcode_history.csv";
    a.click();

    URL.revokeObjectURL(url);
}

document.getElementById("scanBtn").onclick = startScan;
document.getElementById("resetBtn").onclick = resetAll;
document.getElementById("csvBtn").onclick = downloadCSV;

</script>
</body>
</html>



