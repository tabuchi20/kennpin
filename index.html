<!DOCTYPE html>
<html lang="ja">
<head>
<!-- é€šå¸¸ã®favicon -->
<link rel="icon" href="icon/favicon.png" type="image/png">
<link rel="apple-touch-icon" href="icon/icon-180.png">
<link rel="manifest" href="manifest.webmanifest">

<meta charset="UTF-8" />
<title>QRã‚³ãƒ¼ãƒ‰æ¤œå“ Webã‚¢ãƒ—ãƒª</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
body { font-family: -apple-system, BlinkMacSystemFont; padding: 20px; margin-bottom:80px;}
#status { padding: 20px; font-size: 24px; font-weight: bold; border-radius: 12px; text-align: center; margin-bottom: 20px; }
.ok { background: green; color: white; }
.ng { background: red; color: white; }
.normal { background: #e5e5e5; color: #0066cc; }

button { width: 100%; font-size: 20px; padding: 15px; margin-top: 20px; border-radius: 10px; }

table { width: 100%; margin-top: 20px; border-collapse: collapse; }
th, td { border-bottom: 1px solid #ddd; padding: 8px; }

#video-container { max-width: 400px; margin: 20px 0; position: relative; }
video { width: 100%; border-radius: 12px; }

#scan-frame {
    position: absolute;
    top: 50%; left: 50%;
    width: 180px; height: 180px;
    margin-left: -90px; margin-top: -90px;
    border: 3px solid rgba(0,200,0,0.7);
    border-radius: 12px;
    pointer-events: none;
}

/* â–¼ å›ºå®šãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ â–¼ */
.navbar {
    position:fixed;
    bottom:0;
    left:0;
    width:100%;
    background:#f3f3f3;
    border-top:2px solid #ccc;
    display:flex;
    justify-content:space-around;
}
.navbar a {
    flex:1;
    text-align:center;
    padding:15px 0;
    font-size:18px;
    text-decoration:none;
    color:#333;
}
.navbar a.active {
    background:#0078ff;
    color:white;
    font-weight:bold;
}

</style>
</head>
<body>

<h2>QRã‚³ãƒ¼ãƒ‰æ¤œå“ Webã‚¢ãƒ—ãƒª</h2>
<div id="status" class="normal">ç¾å“ç¥¨ã®QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„</div>

<div id="video-container">
    <video id="v" autoplay playsinline></video>
    <div id="scan-frame"></div>
</div>

<button id="scanBtn">ğŸ“· QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹</button>
<button id="resetBtn">ğŸ”„ æœ€åˆã«æˆ»ã‚‹</button>
<button id="exportBtn">ğŸ“ CSVå‡ºåŠ›</button>

<h3>å±¥æ­´</h3>
<table id="history"></table>


<!-- â–¼ ãƒšãƒ¼ã‚¸åˆ‡æ›¿ãƒŠãƒ“ â–¼ -->
<div class="navbar">
    <a href="index.html" class="active">ğŸ“· QRæ¤œå“</a>
    <a href="tenyuryoku.html">âŒ¨ æ‰‹å…¥åŠ›æ¤œå“</a>
</div>


<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>

<script>
let step = 1;
let firstCode1 = "";
let firstCode2 = "";
let secondCode = "";
let scanning = false;

const readSound = new Audio("sounds/yomitori.mp3");
const successSound = new Audio("sounds/seikou.mp3");
const errorSound = new Audio("sounds/keikoku.mp3");

let db;
const req = indexedDB.open("checksDB", 1);
req.onupgradeneeded = (e) => {
    db = e.target.result;
    db.createObjectStore("checks", { keyPath: "id", autoIncrement: true });
};
req.onsuccess = (e) => {
    db = e.target.result;
    loadHistory();
};

function setStatus(text, type="normal") {
    const s = document.getElementById("status");
    s.textContent = text;
    s.className = type;
}

const codeReader = new ZXing.BrowserQRCodeReader();
const videoElement = document.getElementById('v');
const frame = document.getElementById('scan-frame');

async function scan() {
    if (scanning) return;
    scanning = true;
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { ideal: "environment" } }
        });

        videoElement.srcObject = stream;
        const result = await codeReader.decodeOnceFromVideoDevice(undefined, 'v');
        handleScan(result.text);
        stopCamera();

    } catch(e) {
        alert("ã‚«ãƒ¡ãƒ©èµ·å‹•/èª­ã¿å–ã‚Šã«å¤±æ•—: " + e.message);
        stopCamera();
    }
}

function stopCamera() {
    scanning = false;
    const stream = videoElement.srcObject;
    if (stream) stream.getTracks().forEach(track => track.stop());
    videoElement.srcObject = null;
}

function handleScan(code) {
    if (step === 1) {
        if (code.length < 29) {
            setStatus("ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãŒçŸ­ã™ãã¾ã™ï¼ˆ29æ–‡å­—æœªæº€ï¼‰", "ng");
            return;
        }
        readSound.play();
        firstCode1 = code.substring(28, 38);
        firstCode2 = code.length >= 20 ? code.substring(10, 20) : "";
        setStatus("èª­ã¿å–ã‚Šå®Œäº† â†’ ãƒ‘ãƒ¼ãƒ„ãƒ©ãƒ™ãƒ«ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„", "normal");
        step = 2;

    } else if (step === 2) {
        if (code.length < 34) {
            setStatus("ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãŒçŸ­ã™ãã¾ã™ï¼ˆ34æ–‡å­—æœªæº€ï¼‰", "ng");
            return;
        }
        secondCode = code.substring(33, 43);

        let matchOK = (secondCode === firstCode1) || (firstCode2 !== "" && secondCode === firstCode2);

        if (matchOK) {
            setStatus("âœ” ä¸€è‡´ã—ã¾ã—ãŸï¼", "ok");
            successSound.play();
        } else {
            setStatus("âŒ ä¸ä¸€è‡´ã§ã™", "ng");
            errorSound.play();
        }
        saveResult(firstCode1 + (firstCode2 ? " / " + firstCode2 : ""), secondCode, matchOK ? "OK" : "NG");
        loadHistory();

        document.getElementById("scanBtn").style.display = "none";
        step = 3;
    }
}

function saveResult(first, second, result) {
    const tx = db.transaction("checks", "readwrite");
    tx.objectStore("checks").add({
        time: new Date().toLocaleString(),
        first,
        second,
        result
    });
}

function loadHistory() {
    const tx = db.transaction("checks", "readonly");
    const req = tx.objectStore("checks").getAll();
    req.onsuccess = () => {
        const table = document.getElementById("history");
        table.innerHTML = `<tr><th>æ™‚åˆ»</th><th>1å›ç›®</th><th>2å›ç›®</th><th>çµæœ</th></tr>`;
        req.result.reverse().slice(0,5).forEach(r => {
            table.innerHTML += `<tr><td>${r.time}</td><td>${r.first}</td><td>${r.second}</td><td>${r.result}</td></tr>`;
        });
    };
}

function resetAll() {
    step = 1;
    firstCode1 = "";
    firstCode2 = "";
    secondCode = "";
    setStatus("ç¾å“ç¥¨ã®QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„", "normal");
    document.getElementById("scanBtn").style.display = "block";
}

function exportCSV() {
    const tx = db.transaction("checks", "readonly");
    const req = tx.objectStore("checks").getAll();
    req.onsuccess = () => {
        let rows = [["æ™‚åˆ»", "1å›ç›®", "2å›ç›®", "çµæœ"]];
        req.result.forEach(r => rows.push([r.time, r.first, r.second, r.result]));
        let csvContent = rows.map(e => e.join(",")).join("\n");

        const blob = new Blob([csvContent], { type: "text/csv" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = `æ¤œå“å±¥æ­´_${new Date().toLocaleDateString()}.csv`;
        a.click();
        URL.revokeObjectURL(url);
    };
}

document.getElementById("scanBtn").addEventListener("click", scan);
document.getElementById("resetBtn").addEventListener("click", resetAll);
document.getElementById("exportBtn").addEventListener("click", exportCSV);
</script>
</body>
</html>
