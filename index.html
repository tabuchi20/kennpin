<!DOCTYPE html>
<html lang="ja">
<head>
<link rel="icon" href="icon/favicon.png" type="image/png">
<link rel="apple-touch-icon" href="icon/icon-180.png">
<link rel="manifest" href="manifest.webmanifest">

<meta charset="UTF-8" />
<title>QRã‚³ãƒ¼ãƒ‰æ¤œå“</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body { font-family: -apple-system, BlinkMacSystemFont; padding: 20px; margin-bottom:80px;}
#status { padding: 20px; font-size: 24px; font-weight: bold; border-radius: 12px; text-align: center; margin-bottom: 20px; }
.ok { background: green; color: white; }
.ng { background: red; color: white; }
.normal { background: #e5e5e5; color: #0066cc; }

button { width: 100%; font-size: 20px; padding: 15px; margin-top: 20px; border-radius: 10px; }

table { width: 100%; margin-top: 20px; border-collapse: collapse; }
th, td { border-bottom: 1px solid #ddd; padding: 8px; }

#video-container { position: relative; width: 100%; max-width: 400px; margin: auto; }
video { width: 100%; border-radius: 10px; }

#scan-frame {
  width: 220px;
  height: 220px;
  border: 3px solid rgba(255,0,0,0.8);
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
  border-radius: 10px;
}

.navbar {
    position:fixed;
    bottom:0;
    left:0;
    width:100%;
    background:#f3f3f3;
    border-top:2px solid #ccc;
    display:flex;
    justify-content:space-around;
}
.navbar a {
    flex:1;
    text-align:center;
    padding:15px 0;
    font-size:15px;
    text-decoration:none;
    color:#333;
}
.navbar a.active {
    background:#0078ff;
    color:white;
    font-weight:bold;
}
</style>
</head>

<body>

<h2>QRã‚³ãƒ¼ãƒ‰æ¤œå“</h2>
<div id="status" class="normal">ç¾å“ç¥¨ã®QRã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</div>

<div id="video-container">
  <video id="v" autoplay playsinline></video>
  <div id="scan-frame"></div>
</div>

<button id="scanBtn">ğŸ“· QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹</button>
<button id="resetBtn">ğŸ”„ æœ€åˆã«æˆ»ã‚‹</button>
<button id="exportBtn">ğŸ“ CSVå‡ºåŠ›</button>

<h3>å±¥æ­´</h3>
<table id="history"></table>

<div class="navbar">
  <a href="index.html" class="active">ğŸ“· QRæ¤œå“</a>
  <a href="tenyuryoku.html">âŒ¨ æ‰‹å…¥åŠ›æ¤œå“</a>
  <a href="scan.html">ğŸ·ï¸ æµ·å¤–ãƒ©ãƒ™ãƒ«</a>
</div>

<script src="js/jsQR.js"></script>

<script>
// ================= éŸ³å£°å®‰å…¨è¨­è¨ˆ =================

// AudioContextï¼ˆAndroidå¾©å¸°å¯¾ç­–ï¼‰
let audioCtx = null;

// ãƒã‚¹ã‚¿ãƒ¼Audio
let soundMaster = {};

function createSounds() {
  soundMaster = {
    read: new Audio("sounds/yomitori.mp3"),
    ok: new Audio("sounds/seikou.mp3"),
    ng: new Audio("sounds/keikoku.mp3"),
  };
  Object.values(soundMaster).forEach(a => {
    a.preload = "auto";
    a.load();
  });
}

// æ¯å›ã‚¯ãƒ­ãƒ¼ãƒ³å†ç”Ÿï¼ˆæ­»äº¡Audioå›é¿ï¼‰
function playSound(type) {
  try {
    const base = soundMaster[type];
    if (!base) return;

    const a = base.cloneNode();
    a.currentTime = 0;
    a.play().catch(e => {
      console.warn("audio play blocked:", type, e);
    });
  } catch(e) {
    console.error("playSound error:", e);
  }
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§ Audio ã‚’ã‚¢ãƒ³ãƒ­ãƒƒã‚¯
function unlockAudio() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioCtx.state !== "running") {
    audioCtx.resume();
  }
}

// åˆæœŸç”Ÿæˆ
createSounds();

// ã‚¹ãƒªãƒ¼ãƒ—å¾©å¸°æ™‚ï¼šAudioå®Œå…¨å†ç”Ÿæˆ
document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "visible") {
    createSounds();
    audioCtx = null;
  }
});

// ================= QR ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå…ƒã®ã¾ã¾ï¼‰ =================

let step = 1;
let firstCode1 = "";
let firstCode2 = "";
let scanning = false;
let detected = false;

let db;
const req = indexedDB.open("checksDB", 1);
req.onupgradeneeded = e => {
  db = e.target.result;
  db.createObjectStore("checks", { keyPath: "id", autoIncrement: true });
};
req.onsuccess = e => {
  db = e.target.result;
  loadHistory();
};

function setStatus(text, type="normal") {
  const s = document.getElementById("status");
  s.textContent = text;
  s.className = type;
}

const video = document.getElementById("v");

async function scan() {
  if (scanning) return;
  scanning = true;
  detected = false;

  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" }
  });

  video.srcObject = stream;
  requestAnimationFrame(scanLoop);
}

function scanLoop() {
  if (!scanning || detected) return;

  const frame = document.getElementById("scan-frame").getBoundingClientRect();
  const rect = video.getBoundingClientRect();

  const canvas = document.createElement("canvas");
  canvas.width = frame.width;
  canvas.height = frame.height;
  const ctx = canvas.getContext("2d");

  const scaleX = video.videoWidth / rect.width;
  const scaleY = video.videoHeight / rect.height;

  ctx.drawImage(
    video,
    (frame.left - rect.left) * scaleX,
    (frame.top - rect.top) * scaleY,
    frame.width * scaleX,
    frame.height * scaleY,
    0, 0, canvas.width, canvas.height
  );

  const img = ctx.getImageData(0,0,canvas.width,canvas.height);
  const qr = jsQR(img.data, canvas.width, canvas.height);

  if (qr) {
    detected = true;
    stopCamera();
    handleScan(qr.data);
  } else {
    requestAnimationFrame(scanLoop);
  }
}

function stopCamera() {
  scanning = false;
  if (video.srcObject)
    video.srcObject.getTracks().forEach(t => t.stop());
  video.srcObject = null;
}

function handleScan(code) {
  playSound("read");

  if (step === 1) {
    firstCode1 = code.substring(28, 38);
    firstCode2 = code.substring(10, 20);
    setStatus("ãƒ‘ãƒ¼ãƒ„ãƒ©ãƒ™ãƒ«ã®QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚“ã§ãã ã•ã„");
    step = 2;
    return;
  }

  const secondCode = code.substring(33, 43);
  const ok = secondCode === firstCode1 || secondCode === firstCode2;

  setStatus(ok ? "âœ” ä¸€è‡´ã—ã¾ã—ãŸï¼" : "âŒ ä¸ä¸€è‡´ã§ã™", ok ? "ok" : "ng");
  playSound(ok ? "ok" : "ng");
}

scanBtn.onclick = () => {
  unlockAudio();
  playSound("read"); // ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ç¢ºèª
  scan();
};
resetBtn.onclick = () => location.reload();
exportBtn.onclick = () => {};

</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
