<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- 通常のfavicon -->
  <link rel="icon" href="icon/favicon.png" type="image/png">
  <!-- iPhone（ホーム画面追加）のアイコン -->
  <link rel="apple-touch-icon" href="icon/icon-180.png">
  <!-- Android / PWA 用アイコン -->
  <link rel="manifest" href="manifest.webmanifest">

  <meta charset="UTF-8" />
  <title>検品モード Webアプリ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont;
      padding: 20px;
      position: relative;
    }
    #status {
      padding: 20px;
      font-size: 22px;
      font-weight: bold;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 16px;
    }
    .ok { background: #2e7d32; color: white; }
    .ng { background: #c62828; color: white; }
    .normal { background: #e5e5e5; color: #0066cc; }
    .controls { display:flex; gap:12px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    select { font-size:16px; padding:6px 8px; border-radius:6px; }
    button {
      width: 100%;
      font-size: 18px;
      padding: 12px;
      margin-top: 12px;
      border-radius: 10px;
    }
    table {
      width: 100%;
      margin-top: 16px;
      border-collapse: collapse;
    }
    th, td {
      border-bottom: 1px solid #ddd;
      padding: 8px;
      font-size: 14px;
      word-break: break-all;
    }
    #video-container {
      position: relative;
      width: 100%;
      max-width: 480px;
      margin: 12px 0;
    }
    video {
      width: 100%;
      border-radius: 12px;
      background: #000;
    }

    /* 通常スキャン枠（正方形） */
    #scan-frame {
      position: absolute;
      top: 50%; left: 50%;
      width: 180px; height: 180px;
      margin-left: -90px;
      margin-top: -90px;
      border: 3px solid rgba(0,200,0,0.7);
      border-radius: 12px;
      pointer-events: none;
      box-sizing: border-box;
    }

    /* 品番検品時：横長スキャン枠 */
    #scan-frame.hinban-frame {
      width: 260px !important;
      height: 120px !important;
      margin-left: -130px !important;
      margin-top: -60px !important;
      /* border-color はそのまま */
    }

    small.note { color:#666; display:block; margin-top:6px; }
  </style>
</head>
<body>

  <h2>検品モード切替</h2>
  <div class="controls">
    <label for="mode">検品モード：</label>
    <select id="mode">
      <option value="normal">通常検品（QR）</option>
      <option value="hinban">品番検品（バーコード）</option>
    </select>
    <small class="note">通常検品はQR限定。品番検品はバーコードで1〜7桁を比較します。</small>
  </div>

  <div id="status" class="normal">現品票を読み取ってください（モード: 通常検品）</div>

  <div id="video-container">
    <video id="v" autoplay playsinline></video>
    <div id="scan-frame"></div>
  </div>

  <button id="scanBtn">読み取る</button>
  <button id="resetBtn">最初に戻る</button>

  <h3>履歴</h3>
  <table id="history"></table>

  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>

  <script>
  // ステート
  let step = 1;
  let firstRaw = "";
  let secondRaw = "";
  let scanning = false;

  // 音（パスは適宜変更）
  const readSound = new Audio("sounds/yomitori.mp3");
  const successSound = new Audio("sounds/seikou.mp3");
  const errorSound = new Audio("sounds/keikoku.mp3");

  // DOM
  const videoEl = document.getElementById("v");
  const frame = document.getElementById("scan-frame");
  const modeSelect = document.getElementById("mode");
  const statusEl = document.getElementById("status");
  const scanBtn = document.getElementById("scanBtn");
  const resetBtn = document.getElementById("resetBtn");

  // ZXing リーダー
  const qrReader = new ZXing.BrowserQRCodeReader();
  const barcodeReader = new ZXing.BrowserBarcodeReader();

  // IndexedDB（履歴）
  let db;
  const req = indexedDB.open("checksDB", 1);
  req.onupgradeneeded = (e) => {
    db = e.target.result;
    if (!db.objectStoreNames.contains("checks")) {
      db.createObjectStore("checks", { keyPath: "id", autoIncrement: true });
    }
  };
  req.onsuccess = (e) => {
    db = e.target.result;
    loadHistory();
  };

  // スキャン枠の形を更新
  function updateScanFrame() {
    if (modeSelect.value === "hinban") {
      frame.classList.add("hinban-frame");
    } else {
      frame.classList.remove("hinban-frame");
    }
  }

  function setStatus(text, cls="normal") {
    statusEl.textContent = text;
    statusEl.className = cls;
  }

  function stopCamera() {
    scanning = false;
    try {
      const s = videoEl.srcObject;
      if (s) s.getTracks().forEach(t => t.stop());
    } catch (e) {}
    videoEl.srcObject = null;
  }

  async function scan() {
    if (scanning) return;
    scanning = true;

    try {
      const mode = modeSelect.value;

      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: "environment" } }
      });
      videoEl.srcObject = stream;

      let result;
      if (mode === "normal") {
        result = await qrReader.decodeOnceFromVideoDevice(undefined, videoEl);
      } else {
        result = await barcodeReader.decodeOnceFromVideoDevice(undefined, videoEl);
      }

      handleScan(result.text);
    } catch (err) {
      alert("カメラ起動／読み取りに失敗しました: " + (err && err.message ? err.message : err));
    } finally {
      stopCamera();
    }
  }

  function handleScan(code) {
    const mode = modeSelect.value;

    if (step === 1) {
      firstRaw = code;
      try { readSound.play(); } catch(e){}

      if (mode === "normal") {
        if (firstRaw.length < 29) {
          setStatus("1回目のQRが短すぎます（29文字未満）", "ng");
          try { errorSound.play(); } catch(e){}
          return;
        }
        setStatus("1回目完了 → パーツラベルのQRを読み取ってください", "normal");
      } else {
        if (firstRaw.length < 7) {
          setStatus("1回目のバーコードが短すぎます（7文字未満）", "ng");
          try { errorSound.play(); } catch(e){}
          return;
        }
        setStatus("1回目（1〜7桁）完了 → 2回目バーコード（1〜7桁）を読み取ってください", "normal");
      }

      step = 2;
      return;
    }

    if (step === 2) {
      secondRaw = code;
      let matchOK = false;

      if (mode === "normal") {
        if (firstRaw.length < 38) {
          setStatus("1回目のQRが短すぎます（38文字未満）", "ng");
          errorSound.play();
          saveResult(firstRaw, secondRaw, "NG (1回目短い)");
          step = 3;
          scanBtn.style.display = "none";
          return;
        }
        if (secondRaw.length < 43) {
          setStatus("2回目のQRが短すぎます（43文字未満）", "ng");
          errorSound.play();
          saveResult(firstRaw, secondRaw, "NG (2回目短い)");
          step = 3;
          scanBtn.style.display = "none";
          return;
        }

        const firstCode1 = firstRaw.substring(28, 38);
        const firstCode2 = firstRaw.substring(10, 20);
        const secondCode = secondRaw.substring(33, 43);
        matchOK = (secondCode === firstCode1) || (secondCode === firstCode2);

      } else {
        if (firstRaw.length < 7 || secondRaw.length < 7) {
          setStatus("バーコードが短すぎます（7文字未満）", "ng");
          errorSound.play();
          saveResult(firstRaw, secondRaw, "NG (短い)");
          step = 3;
          scanBtn.style.display = "none";
          return;
        }

        const fA = firstRaw.substring(0, 7);
        const sA = secondRaw.substring(0, 7);
        matchOK = (fA === sA);
      }

      if (matchOK) {
        setStatus("一致しました！", "ok");
        successSound.play();
        frame.style.borderColor = "green";
      } else {
        setStatus("不一致です", "ng");
        errorSound.play();
        frame.style.borderColor = "red";
      }

      saveResult(firstRaw, secondRaw, matchOK ? "OK" : "NG");
      loadHistory();

      scanBtn.style.display = "none";
      step = 3;
      return;
    }
  }

  function saveResult(first, second, result) {
    if (!db) return;
    const tx = db.transaction("checks", "readwrite");
    tx.objectStore("checks").add({
      time: new Date().toLocaleString(),
      first,
      second,
      result
    });
  }

  function loadHistory() {
    if (!db) return;
    const tx = db.transaction("checks", "readonly");
    const req = tx.objectStore("checks").getAll();
    req.onsuccess = () => {
      const table = document.getElementById("history");
      table.innerHTML = `<tr><th>時刻</th><th>1回目</th><th>2回目</th><th>結果</th></tr>`;
      (req.result || []).reverse().slice(0, 10).forEach(r => {
        table.innerHTML += `<tr><td>${r.time}</td><td>${escapeHtml(r.first)}</td><td>${escapeHtml(r.second)}</td><td>${r.result}</td></tr>`;
      });
    };
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m=>({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function resetAll() {
    step = 1;
    firstRaw = "";
    secondRaw = "";
    setStatus("現品票を読み取ってください（モード: " +
      (modeSelect.value === "normal" ? "通常検品" : "品番検品") + "）", "normal");
    frame.style.borderColor = 'rgba(0,200,0,0.7)';
    scanBtn.style.display = "block";
    updateScanFrame();
  }

  modeSelect.addEventListener("change", () => {
    setStatus("現品票を読み取ってください（モード: " +
      (modeSelect.value === "normal" ? "通常検品" : "品番検品") + "）", "normal");
    updateScanFrame();
    resetAll();
  });

  // 初期枠設定
  updateScanFrame();

  scanBtn.addEventListener("click", scan);
  resetBtn.addEventListener("click", resetAll);
  </script>

</body>
</html>
