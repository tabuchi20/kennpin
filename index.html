<!DOCTYPE html>
<html lang="ja">
<head>
<link rel="icon" href="icon/favicon.png" type="image/png">
<link rel="apple-touch-icon" href="icon/icon-180.png">
<link rel="manifest" href="manifest.webmanifest">

<meta charset="UTF-8" />
<title>QRã‚³ãƒ¼ãƒ‰æ¤œå“</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body { font-family: -apple-system, BlinkMacSystemFont; padding: 20px; margin-bottom:80px;}
#status { padding: 20px; font-size: 24px; font-weight: bold; border-radius: 12px; text-align: center; margin-bottom: 20px; }
.ok { background: green; color: white; }
.ng { background: red; color: white; }
.normal { background: #e5e5e5; color: #0066cc; }

button { width: 100%; font-size: 20px; padding: 15px; margin-top: 20px; border-radius: 10px; }

table { width: 100%; margin-top: 20px; border-collapse: collapse; }
th, td { border-bottom: 1px solid #ddd; padding: 8px; }

#video-container { position: relative; width: 100%; max-width: 400px; margin: auto; }
video { width: 100%; border-radius: 10px; }

#scan-frame {
  width: 220px;
  height: 220px;
  border: 3px solid rgba(255,0,0,0.8);
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
  border-radius: 10px;
}

.navbar {
    position:fixed;
    bottom:0; left:0;
    width:100%;
    background:#f3f3f3;
    border-top:2px solid #ccc;
    display:flex;
}
.navbar a {
    flex:1;
    text-align:center;
    padding:15px 0;
    font-size:18px;
    text-decoration:none;
    color:#333;
}
.navbar a.active {
    background:#0078ff;
    color:white;
    font-weight:bold;
}
</style>
</head>
<body>

<h2>QRã‚³ãƒ¼ãƒ‰æ¤œå“</h2>
<div id="status" class="normal">ç¾å“ç¥¨ã®QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„</div>

<div id="video-container">
    <video id="v" autoplay playsinline></video>
    <div id="scan-frame"></div>
</div>

<button id="scanBtn">ğŸ“· QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹</button>
<button id="resetBtn">ğŸ”„ æœ€åˆã«æˆ»ã‚‹</button>
<button id="exportBtn">ğŸ“ CSVå‡ºåŠ›</button>

<h3>å±¥æ­´</h3>
<table id="history"></table>

<div class="navbar">
    <a href="index.html" class="active">ğŸ“· QRæ¤œå“</a>
    <a href="tenyuryoku.html">âŒ¨ æ‰‹å…¥åŠ›æ¤œå“</a>
    <a href="scan.html">ğŸ·ï¸ æµ·å¤–ãƒ©ãƒ™ãƒ«</a>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

<script>
let step = 1;
let firstCode1 = "";
let firstCode2 = "";
let scanning = false;

const readSound = new Audio("sounds/yomitori.mp3");
const successSound = new Audio("sounds/seikou.mp3");
const errorSound = new Audio("sounds/keikoku.mp3");

let db;
const req = indexedDB.open("checksDB", 1);
req.onupgradeneeded = e => {
    db = e.target.result;
    db.createObjectStore("checks", { keyPath: "id", autoIncrement: true });
};
req.onsuccess = e => {
    db = e.target.result;
    loadHistory();
};

function setStatus(text, type="normal") {
    const s = document.getElementById("status");
    s.textContent = text;
    s.className = type;
}

const video = document.getElementById("v");
let detected = false;

async function scan() {
    if (scanning) return;
    scanning = true;
    detected = false;

    const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: "environment" } }
    });

    video.srcObject = stream;
    requestAnimationFrame(scanLoop);
}

function scanLoop() {
    if (!scanning || detected) return;

    const frame = document.getElementById("scan-frame").getBoundingClientRect();
    const rect  = video.getBoundingClientRect();

    const canvas = document.createElement("canvas");
    canvas.width = frame.width;
    canvas.height = frame.height;
    const ctx = canvas.getContext("2d");

    const sx = video.videoWidth / rect.width;
    const sy = video.videoHeight / rect.height;

    ctx.drawImage(video,
        (frame.left-rect.left)*sx,
        (frame.top-rect.top)*sy,
        frame.width*sx,
        frame.height*sy,
        0,0,canvas.width,canvas.height
    );

    const img = ctx.getImageData(0,0,canvas.width,canvas.height);
    const qr = jsQR(img.data, canvas.width, canvas.height);

    if (qr) {
        detected = true;
        stopCamera();
        handleScan(qr.data);
    } else {
        requestAnimationFrame(scanLoop);
    }
}

function stopCamera() {
    scanning = false;
    video.srcObject?.getTracks().forEach(t=>t.stop());
    video.srcObject = null;
}

function handleScan(code) {
    readSound.play();

    /* 1å›ç›®ï¼šåŸºæº–QR */
    if (step === 1) {
        if (code.length < 29) {
            setStatus("ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãŒçŸ­ã™ãã¾ã™ï¼ˆ29æ–‡å­—æœªæº€ï¼‰","ng");
            return;
        }

        firstCode1 = code.substring(28, 38);
        firstCode2 = code.length >= 20 ? code.substring(10, 20) : "";

        setStatus("åŸºæº–QRç™»éŒ²æ¸ˆã¿ â†’ ãƒ‘ãƒ¼ãƒ„ãƒ©ãƒ™ãƒ«ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„","normal");
        step = 2;
        return;
    }

    /* 2å›ç›®ä»¥é™ï¼šé€£ç¶šåˆ¤å®š */
    if (step === 2) {
        if (code.length < 34) {
            setStatus("ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãŒçŸ­ã™ãã¾ã™ï¼ˆ34æ–‡å­—æœªæº€ï¼‰","ng");
            return;
        }

        const secondCode = code.substring(33, 43);

        const ok =
            secondCode === firstCode1 ||
            (firstCode2 && secondCode === firstCode2);

        if (ok) {
            setStatus("âœ” ä¸€è‡´ã—ã¾ã—ãŸï¼","ok");
            successSound.play();
        } else {
            setStatus("âŒ ä¸ä¸€è‡´ã§ã™","ng");
            errorSound.play();
        }

        saveResult(
            firstCode1 + (firstCode2 ? " / " + firstCode2 : ""),
            secondCode,
            ok ? "OK" : "NG"
        );

        loadHistory();
        setStatus("æ¬¡ã®ãƒ‘ãƒ¼ãƒ„ãƒ©ãƒ™ãƒ«ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„","normal");
    }
}

function saveResult(first, second, result) {
    const tx = db.transaction("checks","readwrite");
    tx.objectStore("checks").add({
        time: new Date().toLocaleString(),
        first, second, result
    });
}

function loadHistory() {
    const tx = db.transaction("checks","readonly");
    const req = tx.objectStore("checks").getAll();

    req.onsuccess = () => {
        const table = document.getElementById("history");
        table.innerHTML = "<tr><th>æ™‚åˆ»</th><th>1å›ç›®</th><th>2å›ç›®</th><th>çµæœ</th></tr>";
        req.result.reverse().slice(0,5).forEach(r=>{
            table.innerHTML += `
            <tr>
              <td>${r.time}</td>
              <td>${r.first}</td>
              <td>${r.second}</td>
              <td>${r.result}</td>
            </tr>`;
        });
    };
}

function resetAll() {
    step = 1;
    firstCode1 = "";
    firstCode2 = "";
    setStatus("ç¾å“ç¥¨ã®QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„","normal");
}

function exportCSV() {
    const tx = db.transaction("checks","readonly");
    const req = tx.objectStore("checks").getAll();

    req.onsuccess = () => {
        let csv = "æ™‚åˆ»,1å›ç›®,2å›ç›®,çµæœ\n";
        req.result.forEach(r=>{
            csv += `${r.time},${r.first},${r.second},${r.result}\n`;
        });

        const blob = new Blob([csv],{type:"text/csv"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "æ¤œå“å±¥æ­´.csv";
        a.click();
    };
}

scanBtn.onclick = scan;
resetBtn.onclick = resetAll;
exportBtn.onclick = exportCSV;
</script>

</body>
</html>
