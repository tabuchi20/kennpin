<!DOCTYPE html>
<html lang="ja">
<head>

<!-- favicon -->
<link rel="icon" href="icon/favicon.png" type="image/png">

<!-- iPhone ホーム画面アイコン -->
<link rel="apple-touch-icon" href="icon/icon-180.png">

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">

<meta charset="UTF-8" />
<title>QRコード検品 Webアプリ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body {
    font-family: -apple-system, BlinkMacSystemFont;
    padding: 20px;
}
#status {
    padding: 20px;
    font-size: 22px;
    font-weight: bold;
    border-radius: 12px;
    text-align: center;
    margin-bottom: 20px;
}
.ok { background: green; color: white; }
.ng { background: red; color: white; }
.normal { background: #e5e5e5; color: #0066cc; }

button {
    width: 100%;
    font-size: 20px;
    padding: 12px;
    margin-top: 15px;
    border-radius: 10px;
}

#video-container {
    position: relative;
    width: 100%;
    max-width: 420px;
    margin: 20px auto;
}
video {
    width: 100%;
    border-radius: 12px;
}

/* 通常検品（正方形） */
.scan-frame-normal {
    position: absolute;
    top: 50%; left: 50%;
    width: 180px; height: 180px;
    margin-left: -90px;
    margin-top: -90px;
    border: 3px solid rgba(0,200,0,0.7);
    border-radius: 12px;
    pointer-events: none;
}

/* 品番検品（横長） */
.scan-frame-wide {
    position: absolute;
    top: 50%; left: 50%;
    width: 260px; height: 130px;
    margin-left: -130px;
    margin-top: -65px;
    border: 3px solid rgba(0,200,0,0.7);
    border-radius: 12px;
    pointer-events: none;
}

table {
    width: 100%;
    margin-top: 20px;
    border-collapse: collapse;
}
th, td {
    border-bottom: 1px solid #ddd;
    padding: 8px;
}

</style>
</head>
<body>

<h2>検品 Webアプリ</h2>

<!-- ▼ 検品モード切替 ▼ -->
<label>
    <input type="radio" name="mode" value="normal" checked>
    通常検品（QR）
</label>
<label style="margin-left:20px;">
    <input type="radio" name="mode" value="hinban">
    品番検品（バーコード）
</label>

<div id="status" class="normal">現品票のQRコードを読み取ってください</div>

<div id="video-container">
    <video id="v" autoplay playsinline></video>
    <div id="scan-frame" class="scan-frame-normal"></div>
</div>

<button id="scanBtn">読み取り開始</button>
<button id="resetBtn">最初に戻る</button>

<h3>履歴</h3>
<table id="history"></table>

<script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>

<script>
/* --------------------
   状態変数
-------------------- */
let step = 1;
let mode = "normal"; // normal / hinban
let scanning = false;

let firstA = "";
let firstB = "";
let secondA = "";

/* 音声 */
const readSound = new Audio("sounds/yomitori.mp3");
const successSound = new Audio("sounds/seikou.mp3");
const errorSound = new Audio("sounds/keikoku.mp3");

/* DB */
let db;
const req = indexedDB.open("checksDB", 1);
req.onupgradeneeded = e => {
    db = e.target.result;
    db.createObjectStore("checks", { keyPath: "id", autoIncrement: true });
};
req.onsuccess = e => {
    db = e.target.result;
    loadHistory();
};

/* --------------------
   UI 設定
-------------------- */
function setStatus(text, type="normal") {
    const s = document.getElementById("status");
    s.textContent = text;
    s.className = type;
}

/* モード切替 */
document.querySelectorAll("input[name='mode']").forEach(r => {
    r.addEventListener("change", () => {
        mode = document.querySelector("input[name='mode']:checked").value;
        resetAll();

        const frame = document.getElementById("scan-frame");

        if (mode === "normal") {
            setStatus("現品票のQRコードを読み取ってください");
            frame.className = "scan-frame-normal";
        } else {
            setStatus("品番ラベルのバーコードを読み取ってください");
            frame.className = "scan-frame-wide";
        }
    });
});

/* --------------------
   カメラ読取
-------------------- */
const qrReader = new ZXing.BrowserQRCodeReader();
const codeReader = new ZXing.BrowserMultiFormatReader();
const video = document.getElementById("v");

async function scan() {
    if (scanning) return;
    scanning = true;

    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { ideal: "environment" } }
        });
        video.srcObject = stream;

        let result;

        if (mode === "normal") {
            result = await qrReader.decodeOnceFromVideoDevice(undefined, "v");
        } else {
            result = await codeReader.decodeOnceFromVideoDevice(undefined, "v");
        }

        handleScan(result.text);
        stopCamera();

    } catch (e) {
        alert("カメラ起動に失敗：" + e.message);
        stopCamera();
    }
}

function stopCamera() {
    scanning = false;
    const stream = video.srcObject;
    if (stream) stream.getTracks().forEach(t => t.stop());
    video.srcObject = null;
}

/* --------------------
   検品処理
-------------------- */
function handleScan(code) {
    console.log("code=", code);

    /* ▼ 通常検品（QR） ------------------ */
    if (mode === "normal") {

        if (step === 1) {
            if (code.length < 29) {
                setStatus("バーコードが短すぎます（29文字未満）", "ng");
                return;
            }
            readSound.play();

            firstA = code.substring(28, 38);
            firstB = code.length >= 20 ? code.substring(10, 20) : "";

            setStatus("パーツラベルを読み取ってください");
            step = 2;
        }

        else if (step === 2) {
            if (code.length < 34) {
                setStatus("バーコードが短すぎます（34文字未満）", "ng");
                return;
            }

            secondA = code.substring(33, 43);

            let ok = (secondA === firstA) || (firstB && secondA === firstB);

            finishCheck(ok, firstA + " / " + firstB, secondA);
        }
    }

    /* ▼ 品番検品（バーコード） ------------------ */
    if (mode === "hinban") {

        if (step === 1) {
            if (code.length < 7) {
                setStatus("バーコードが短すぎます（7文字未満）", "ng");
                return;
            }
            readSound.play();

            firstA = code.substring(0, 7);
            setStatus("もう一度品番ラベルを読み取ってください");
            step = 2;
        }

        else if (step === 2) {
            if (code.length < 7) {
                setStatus("バーコードが短すぎます（7文字未満）", "ng");
                return;
            }

            secondA = code.substring(0, 7);

            let ok = (secondA === firstA);

            finishCheck(ok, firstA, secondA);
        }
    }
}

/* 検査完了 */
function finishCheck(ok, first, second) {
    const frame = document.getElementById("scan-frame");

    if (ok) {
        setStatus("一致しました！", "ok");
        successSound.play();
        frame.style.borderColor = "green";
    } else {
        setStatus("不一致です", "ng");
        errorSound.play();
        frame.style.borderColor = "red";
    }

    saveResult(first, second, ok ? "OK" : "NG");
    loadHistory();
    document.getElementById("scanBtn").style.display = "none";

    step = 3;
}

/* --------------- DB ----------------- */
function saveResult(first, second, result) {
    const tx = db.transaction("checks", "readwrite");
    tx.objectStore("checks").add({
        time: new Date().toLocaleString(),
        first,
        second,
        result
    });
}

function loadHistory() {
    const tx = db.transaction("checks", "readonly");
    const r = tx.objectStore("checks").getAll();
    r.onsuccess = () => {
        const table = document.getElementById("history");
        table.innerHTML = `<tr><th>時刻</th><th>1回目</th><th>2回目</th><th>結果</th></tr>`;
        r.result.reverse().slice(0, 5).forEach(d => {
            table.innerHTML += `<tr>
                <td>${d.time}</td>
                <td>${d.first}</td>
                <td>${d.second}</td>
                <td>${d.result}</td>
            </tr>`;
        });
    };
}

/* --------------------
   リセット
-------------------- */
function resetAll() {
    stopCamera();
    step = 1;

    firstA = firstB = secondA = "";

    document.getElementById("scanBtn").style.display = "block";
    document.getElementById("scan-frame").style.borderColor = "rgba(0,200,0,0.7)";

    if (mode === "normal") {
        setStatus("現品票のQRコードを読み取ってください", "normal");
    } else {
        setStatus("品番ラベルのバーコードを読み取ってください", "normal");
    }
}

document.getElementById("scanBtn").addEventListener("click", scan);
document.getElementById("resetBtn").addEventListener("click", resetAll);

</script>

</body>
</html>
