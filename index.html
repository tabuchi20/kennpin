<!DOCTYPE html>
<html lang="ja">
<head>
<link rel="icon" href="icon/favicon.png" type="image/png">
<link rel="apple-touch-icon" href="icon/icon-180.png">
<link rel="manifest" href="manifest.webmanifest">

<meta charset="UTF-8" />
<title>QRã‚³ãƒ¼ãƒ‰æ¤œå“</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body { font-family: -apple-system, BlinkMacSystemFont; padding: 20px; margin-bottom:80px;}
#status { padding: 20px; font-size: 24px; font-weight: bold; border-radius: 12px; text-align: center; margin-bottom: 20px; }
.ok { background: green; color: white; }
.ng { background: red; color: white; }
.normal { background: #e5e5e5; color: #0066cc; }

button { width: 100%; font-size: 20px; padding: 15px; margin-top: 20px; border-radius: 10px; }

table { width: 100%; margin-top: 20px; border-collapse: collapse; }
th, td { border-bottom: 1px solid #ddd; padding: 8px; }

#video-container { position: relative; width: 100%; max-width: 400px; margin: auto; }
video { width: 100%; border-radius: 10px; }

#scan-frame {
  width: 220px;
  height: 220px;
  border: 3px solid rgba(255,0,0,0.8);
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
  border-radius: 10px;
}

.navbar {
    position:fixed;
    bottom:0;
    left:0;
    width:100%;
    background:#f3f3f3;
    border-top:2px solid #ccc;
    display:flex;
    justify-content:space-around;
}
.navbar a {
    flex:1;
    text-align:center;
    padding:15px 0;
    font-size:15px;
    text-decoration:none;
    color:#333;
}
.navbar a.active {
    background:#0078ff;
    color:white;
    font-weight:bold;
}
</style>
</head>
<body>

<h2>QRã‚³ãƒ¼ãƒ‰æ¤œå“</h2>
<div id="status" class="normal">ç¾å“ç¥¨ã®QRã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</div>

<div id="video-container">
    <video id="v" autoplay playsinline></video>
    <div id="scan-frame"></div>
</div>

<button id="scanBtn">ğŸ“· QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹</button>
<button id="resetBtn">ğŸ”„ æœ€åˆã«æˆ»ã‚‹</button>
<button id="exportBtn">ğŸ“ CSVå‡ºåŠ›</button>

<h3>å±¥æ­´</h3>
<table id="history"></table>

<div class="navbar">
    <a href="index.html" class="active">ğŸ“· QRæ¤œå“</a>
    <a href="tenyuryoku.html">âŒ¨ æ‰‹å…¥åŠ›æ¤œå“</a>
    <a href="scan.html">ğŸ·ï¸ æµ·å¤–ãƒ©ãƒ™ãƒ«</a>
</div>

<script src="js/jsQR.js"></script>

<script>
let step = 1;
let firstCode1 = "";
let firstCode2 = "";
let scanning = false;
let detected = false;

/* ===== éŸ³ ===== */
const readSound    = new Audio("sounds/yomitori.mp3");
const successSound = new Audio("sounds/seikou.mp3");
const errorSound   = new Audio("sounds/keikoku.mp3");

let audioUnlocked = false;

/* â˜… Androidå¯¾ç­–ï¼šéŸ³ã¯ä¸€åº¦ã ã‘ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ */
function unlockAudioOnce() {
    if (audioUnlocked) return;
    audioUnlocked = true;

    [readSound, successSound, errorSound].forEach(sound => {
        sound.play().then(() => {
            sound.pause();
            sound.currentTime = 0;
        }).catch(()=>{});
    });
}

/* ===== IndexedDB ===== */
let db;
const req = indexedDB.open("checksDB", 1);
req.onupgradeneeded = e => {
    db = e.target.result;
    db.createObjectStore("checks", { keyPath: "id", autoIncrement: true });
};
req.onsuccess = e => {
    db = e.target.result;
    loadHistory();
};

function setStatus(text, type="normal") {
    const s = document.getElementById("status");
    s.textContent = text;
    s.className = type;
}

const video = document.getElementById("v");

/* ===== ã‚«ãƒ¡ãƒ©èµ·å‹• ===== */
async function scan() {
    if (scanning) return;
    scanning = true;
    detected = false;

    const stream = await navigator.mediaDevices.getUserMedia({
        video: {
            facingMode: { ideal: "environment" },
            width: { ideal: 1920 },
            height: { ideal: 1080 }
        }
    });

    video.srcObject = stream;
    requestAnimationFrame(scanLoop);
}

/* ===== ã‚¹ã‚­ãƒ£ãƒ³å‡¦ç† ===== */
function scanLoop() {
    if (!scanning || detected) return;

    const frame = document.getElementById("scan-frame").getBoundingClientRect();
    const rect  = video.getBoundingClientRect();

    const canvas = document.createElement("canvas");
    canvas.width  = frame.width;
    canvas.height = frame.height;
    const ctx = canvas.getContext("2d");

    const scaleX = video.videoWidth / rect.width;
    const scaleY = video.videoHeight / rect.height;

    ctx.drawImage(
        video,
        (frame.left - rect.left) * scaleX,
        (frame.top  - rect.top ) * scaleY,
        frame.width  * scaleX,
        frame.height * scaleY,
        0, 0, canvas.width, canvas.height
    );

    const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
    const qr = jsQR(imageData.data, canvas.width, canvas.height);

    if (qr) {
        detected = true;
        stopCamera();
        handleScan(qr.data);
    } else {
        requestAnimationFrame(scanLoop);
    }
}

function stopCamera() {
    scanning = false;
    if (video.srcObject)
        video.srcObject.getTracks().forEach(t => t.stop());
    video.srcObject = null;
}

/* ===== åˆ¤å®š ===== */
function handleScan(code) {
    readSound.play();

    if (step === 1) {
        if (code.length < 29) {
            setStatus("ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãŒçŸ­ã™ãã¾ã™ï¼ˆ29æ–‡å­—æœªæº€ï¼‰", "ng");
            errorSound.play();
            return;
        }

        firstCode1 = code.substring(28, 38);
        firstCode2 = code.length >= 20 ? code.substring(10, 20) : "";

        setStatus("ãƒ‘ãƒ¼ãƒ„ãƒ©ãƒ™ãƒ«ã®QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚“ã§ãã ã•ã„", "normal");
        step = 2;
        return;
    }

    if (step === 2) {
        if (code.length < 34) {
            setStatus("ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãŒçŸ­ã™ãã¾ã™ï¼ˆ34æ–‡å­—æœªæº€ï¼‰", "ng");
            errorSound.play();
            return;
        }

        const secondCode = code.substring(33, 43);
        const ok =
            secondCode === firstCode1 ||
            (firstCode2 && secondCode === firstCode2);

        if (ok) {
            setStatus("âœ” ä¸€è‡´ã—ã¾ã—ãŸï¼", "ok");
            successSound.play();
        } else {
            setStatus("âŒ ä¸ä¸€è‡´ã§ã™", "ng");
            errorSound.play();
        }

        saveResult(
            firstCode1 + (firstCode2 ? " / " + firstCode2 : ""),
            secondCode,
            ok ? "OK" : "NG"
        );

        loadHistory();
    }
}

/* ===== DB ===== */
function saveResult(first, second, result) {
    const tx = db.transaction("checks","readwrite");
    tx.objectStore("checks").add({
        time: new Date().toLocaleString(),
        first, second, result
    });
}

function loadHistory() {
    const tx = db.transaction("checks","readonly");
    const req = tx.objectStore("checks").getAll();

    req.onsuccess = () => {
        const table = document.getElementById("history");
        table.innerHTML =
            "<tr><th>æ™‚åˆ»</th><th>1å›ç›®</th><th>2å›ç›®</th><th>çµæœ</th></tr>";
        req.result.reverse().slice(0,5).forEach(r=>{
            table.innerHTML += `
            <tr>
              <td>${r.time}</td>
              <td>${r.first}</td>
              <td>${r.second}</td>
              <td>${r.result}</td>
            </tr>`;
        });
    };
}

/* ===== ãƒªã‚»ãƒƒãƒˆ ===== */
function resetAll() {
    step = 1;
    firstCode1 = "";
    firstCode2 = "";
    setStatus("ç¾å“ç¥¨ã®QRã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„", "normal");
}

/* ===== CSV ===== */
function exportCSV() {
    const tx = db.transaction("checks","readonly");
    const req = tx.objectStore("checks").getAll();

    req.onsuccess = () => {
        let csv = "æ™‚åˆ»,1å›ç›®,2å›ç›®,çµæœ\n";
        req.result.forEach(r=>{
            csv += `${r.time},${r.first},${r.second},${r.result}\n`;
        });

        const blob = new Blob([csv],{type:"text/csv"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "æ¤œå“å±¥æ­´.csv";
        a.click();
    };
}

/* ===== ã‚¤ãƒ™ãƒ³ãƒˆ ===== */
scanBtn.onclick = () => {
    unlockAudioOnce();   // â˜… åˆå›ã ã‘éŸ³ã‚’è§£æ”¾
    scan();              // â˜… ã‚«ãƒ¡ãƒ©ã¯å¸¸ã«å®‰å®š
};
resetBtn.onclick = resetAll;
exportBtn.onclick = exportCSV;
</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
