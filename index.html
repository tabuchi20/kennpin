<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>QR・バーコード検品 Webアプリ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    padding: 20px;
}
#status {
    padding: 15px;
    border-radius: 10px;
    font-size: 22px;
    margin: 10px 0;
    background: #eee;
}
#reader {
    width: 100%;
    max-width: 400px;
    margin: auto;
}
.success { background: #c8f7c5 !important; }
.error   { background: #f7c5c5 !important; }

.mode-btn {
    padding: 12px 20px;
    margin: 5px;
    font-size: 16px;
}
</style>
</head>

<body>

<h2>検品アプリ</h2>

<div>
    <button class="mode-btn" onclick="setMode('normal')">通常検品</button>
    <button class="mode-btn" onclick="setMode('hinban')">品番検品</button>
</div>

<div id="status">モードを選択してください</div>

<div id="reader"></div>

<button onclick="resetAll()">最初に戻る</button>

<script>
let mode = "";         // normal / hinban
let step = 1;
let firstA = "";
let secondA = "";

let html5QrCode;
let cameraId = null;

const readSound = new Audio("https://tabuchi20.github.io/sound/ok.mp3");
const errorSound = new Audio("https://tabuchi20.github.io/sound/ng.mp3");


// -----------------------------------------------------
// ステータス表示
// -----------------------------------------------------
function setStatus(msg, type = "") {
    const s = document.getElementById("status");
    s.textContent = msg;
    s.className = "";
    if (type === "ok") s.classList.add("success");
    if (type === "ng") s.classList.add("error");
}


// -----------------------------------------------------
// モード選択
// -----------------------------------------------------
async function setMode(m) {
    mode = m;
    resetStateOnly();

    if (mode === "normal") {
        setStatus("現品票 QRコードを読み取ってください");
    } else {
        setStatus("品番ラベルを読み取ってください");
    }

    await startCamera();
}


// -----------------------------------------------------
// 初期化（ボタンの「最初に戻る」用）
// -----------------------------------------------------
function resetAll() {
    resetStateOnly();

    if (mode === "normal") {
        setStatus("現品票 QRコードを読み取ってください");
    } else if (mode === "hinban") {
        setStatus("品番ラベルを読み取ってください");
    } else {
        setStatus("モードを選択してください");
    }

    startCamera();
}

// 状態のみクリア
function resetStateOnly() {
    step = 1;
    firstA = "";
    secondA = "";
}


// -----------------------------------------------------
// カメラ開始
// -----------------------------------------------------
async function startCamera() {
    try {
        if (html5QrCode) {
            try { await html5QrCode.stop(); } catch {}
        }

        html5QrCode = new Html5Qrcode("reader");

        const devices = await Html5Qrcode.getCameras();
        if (devices.length === 0) {
            setStatus("カメラが見つかりません", "ng");
            return;
        }
        cameraId = devices[0].id;

        const config = {
            fps: 10,
            qrbox: mode === "hinban"
                ? { width: 350, height: 120 }  // 品番検品は横長
                : 250
        };

        html5QrCode.start(
            cameraId,
            config,
            onScanSuccess,
            onScanError
        );
    } catch (err) {
        setStatus("カメラ起動エラー: " + err, "ng");
    }
}


// -----------------------------------------------------
// 読み取り成功
// -----------------------------------------------------
function onScanSuccess(decodedText) {
    handleScan(decodedText.trim());
}


// -----------------------------------------------------
// 読み取りエラー(無視)
// -----------------------------------------------------
function onScanError() {}


// -----------------------------------------------------
// 検品処理本体
// -----------------------------------------------------
function handleScan(code) {

    /* ===========================================
       ▼ 通常検品（QR）
       =========================================== */
    if (mode === "normal") {

        if (step === 1) {
            if (code.length < 28 || code.length > 38) {
                setStatus("QRコードの桁数が不正です（28〜38桁）", "ng");
                errorSound.play();
                return;
            }
            readSound.play();
            firstA = code;
            step = 2;
            setStatus("製品QRを読み取ってください");
            return;
        }

        if (step === 2) {
            if (code.length < 10 || code.length > 20) {
                setStatus("2回目のQRが10〜20桁ではありません", "ng");
                errorSound.play();
                return;
            }
            secondA = code;

            let ok = (firstA === secondA);
            finishCheck(ok, firstA, secondA);
            return;
        }
    }


    /* ===========================================
       ▼ 品番検品（バーコード）
       =========================================== */
    if (mode === "hinban") {

        if (step === 1) {
            if (code.length < 7) {
                setStatus("バーコードが短すぎます（7文字未満）", "ng");
                errorSound.play();
                return;
            }

            firstA = code.substring(0, 7);
            readSound.play();

            step = 2;
            setStatus("もう一度品番ラベルを読み取ってください");
            return;
        }

        if (step === 2) {

            if (code.length < 10) {
                setStatus("2回目は10文字以上のバーコードを読み取ってください", "ng");
                errorSound.play();
                return;
            }

            secondA = code.substring(0, 7);

            let ok = (firstA === secondA);
            finishCheck(ok, firstA, secondA);
            return;
        }
    }
}


// -----------------------------------------------------
// 完了処理
// -----------------------------------------------------
async function finishCheck(ok, a, b) {
    if (ok) {
        readSound.play();
        setStatus("✓ 一致しました", "ok");
    } else {
        errorSound.play();
        setStatus(`× 不一致： ${a} ≠ ${b}`, "ng");
    }

    // カメラ停止して再度起動できるようにする
    try { await html5QrCode.stop(); } catch {}
}
</script>

</body>
</html>
