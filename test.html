<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>æµ·å¤–ãƒ©ãƒ™ãƒ«è²¼ã‚Šæ¤œå“</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: -apple-system, BlinkMacSystemFont; padding: 20px; margin-bottom:80px; }
#status { padding: 20px; font-size: 24px; font-weight: bold; border-radius: 12px; text-align: center; margin-bottom: 10px; }
.ok { background: green; color: white; }
.ng { background: red; color: white; }
.normal { background: #e5e5e5; color: #0066cc; }

#firstCodeDisplay { font-size: 20px; margin-bottom: 20px; font-weight: bold; }

#video-container { position: relative; width: 100%; max-width: 400px; margin: auto; }
video { width: 100%; border-radius: 10px; }

#scan-frame {
  width: 260px;
  height: 160px;
  border: 3px solid rgba(255,0,0,0.8);
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
  border-radius: 10px;
}

button { width: 100%; font-size: 20px; padding: 15px; margin-top: 20px; border-radius: 10px; }

table { width: 100%; margin-top: 20px; border-collapse: collapse; }
th, td { border-bottom: 1px solid #ddd; padding: 8px; }

.navbar {
  position:fixed;
  bottom:0; left:0;
  width:100%;
  background:#f3f3f3;
  border-top:2px solid #ccc;
  display:flex;
}
.navbar a {
  flex:1;
  text-align:center;
  padding:15px 0;
  font-size:18px;
  text-decoration:none;
  color:#333;
}
.navbar a.active {
  background:#0078ff;
  color:white;
  font-weight:bold;
}

/* ===== æ”¹ä¿®ä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ===== */
#maintenanceOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  color: #fff;
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
}
#maintenanceOverlay .overlay-content {
  padding: 30px;
  border-radius: 12px;
  background: #222;
  max-width: 90%;
}
#maintenanceOverlay h2 {
  font-size: 24px;
  margin-bottom: 15px;
}
#maintenanceOverlay p {
  font-size: 16px;
  margin-bottom: 10px;
}
#maintenanceOverlay .tap {
  margin-top: 20px;
  font-size: 18px;
  font-weight: bold;
  color: #4da3ff;
}
</style>
</head>

<div id="maintenanceOverlay">
  <div class="overlay-content">
    <h2>ç¾åœ¨æ”¹ä¿®ä¸­ã§ã™</h2>
    <p>ã‚·ã‚¹ãƒ†ãƒ èª¿æ•´ã®ãŸã‚ä¸€æ™‚çš„ã«<br>è¡¨ç¤ºåˆ¶é™ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚</p>
    <p class="tap">â–¶ ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã—ã¦èµ·å‹•</p>
  </div>
</div>

<body>

<h2>æµ·å¤–ãƒ©ãƒ™ãƒ«è²¼ã‚Šæ¤œå“</h2>

<div id="status" class="normal">æµ·å¤–ãƒ‘ãƒ¼ãƒ„ãƒ©ãƒ™ãƒ«ã®å“ç•ªã‚’èª­ã¿å–ã£ã¦ãã ã•ã„</div>
<div id="firstCodeDisplay"></div>

<div id="video-container">
  <video id="v" autoplay playsinline></video>
  <div id="scan-frame"></div>
</div>

<button id="scanBtn">ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹</button>
<button id="resetBtn">ğŸ”„ æœ€åˆã«æˆ»ã‚‹</button>
<button id="csvBtn">ğŸ“„ CSVå‡ºåŠ›</button>

<h3>å±¥æ­´ï¼ˆæœ€æ–°5ä»¶ï¼‰</h3>
<table id="history"></table>

<div class="navbar">
  <a href="index.html">ğŸ“· QRæ¤œå“</a>
  <a href="tenyuryoku.html">âŒ¨ æ‰‹å…¥åŠ›æ¤œå“</a>
  <a href="scan.html" class="active">ğŸ·ï¸ æµ·å¤–ãƒ©ãƒ™ãƒ«</a>
</div>

<script src="js/zxing.min.js"></script>

<script>
// ================= IndexedDB =================
let db;
const request = indexedDB.open("barcodeDB", 1);

request.onupgradeneeded = e => {
  db = e.target.result;
  db.createObjectStore("records", { keyPath: "id", autoIncrement: true });
};
request.onsuccess = e => {
  db = e.target.result;
  loadHistory();
};

// ================= éŸ³ãƒ»æŒ¯å‹• =================
const readSound = new Audio("sounds/yomitori.mp3");
const successSound = new Audio("sounds/seikou.mp3");
const errorSound = new Audio("sounds/keikoku.mp3");
const vibrate = p => navigator.vibrate && navigator.vibrate(p);

// ========== å¤‰æ•° ==========
let step = 1;
let firstCode = "";
let secondCode = "";
let scanning = false;

const reader = new ZXing.BrowserMultiFormatReader();
const video = document.getElementById("v");

// ========== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ ==========
function setStatus(text, type="normal") {
  const s = document.getElementById("status");
  s.textContent = text;
  s.className = type;
}

// ========== ã‚«ãƒ¡ãƒ©é–‹å§‹ï¼ˆâ˜…Android/iPhoneä¸¡å¯¾å¿œï¼‰ ==========
async function startScan() {
  if (scanning) return;
  scanning = true;

  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: "environment" } }
    });

    video.srcObject = stream;

    reader.decodeFromVideoElement(video, (result, err) => {
      if (result) {
        handleScan(result.text);
      }
    });

  } catch (e) {
    alert("ã‚«ãƒ¡ãƒ©ãŒä½¿ç”¨ã§ãã¾ã›ã‚“ï¼š" + e.message);
    scanning = false;
  }
}

// ========== ã‚«ãƒ¡ãƒ©åœæ­¢ ==========
function stopCamera() {
  scanning = false;
  reader.reset();
  if (video.srcObject) {
    video.srcObject.getTracks().forEach(t => t.stop());
  }
  video.srcObject = null;
}

// ========== ã‚¹ã‚­ãƒ£ãƒ³å¾Œå‡¦ç† ==========
function handleScan(code) {
  stopCamera();

  const scanned = code.trim();
  readSound.currentTime = 0;
  readSound.play();
  vibrate(150);

  if (step === 1) {
    if (scanned.length > 7) {
      errorSound.play();
      setStatus("âŒ 1å›ç›®ã¯7æ–‡å­—ä»¥ä¸‹ã§èª­ã¿å–ã£ã¦ãã ã•ã„", "ng");
      return;
    }
    firstCode = scanned;
    document.getElementById("firstCodeDisplay").textContent = "1å›ç›®ã®ã‚³ãƒ¼ãƒ‰ : " + firstCode;
    setStatus("æµ·å¤–ãƒ‘ãƒ¼ãƒ„ãƒ©ãƒ™ãƒ«ã®å“ç•ªã‚’èª­ã¿å–ã£ã¦ãã ã•ã„");
    step = 2;
    return;
  }

  if (step === 2) {
    if (scanned.length < 8) {
      errorSound.play();
      setStatus("âŒ 2å›ç›®ã¯è²¼ã‚Šä»˜ã‘ã‚‹ãƒ‘ãƒ¼ãƒ„ãƒ©ãƒ™ãƒ«ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„", "ng");
      return;
    }
    secondCode = scanned;
    const ok = secondCode.includes(firstCode);

    if (ok) {
      successSound.play();
      setStatus("âœ” ä¸€è‡´ã—ã¾ã—ãŸï¼", "ok");
    } else {
      errorSound.play();
      setStatus("âŒ ä¸ä¸€è‡´ã§ã™", "ng");
    }

    saveHistory(firstCode, secondCode, ok ? "OK" : "NG");
    document.getElementById("scanBtn").style.display = "none";
    step = 3;
  }
}

// ========== ãƒªã‚»ãƒƒãƒˆ ==========
function resetAll() {
  stopCamera();
  step = 1;
  firstCode = "";
  setStatus("æµ·å¤–ãƒ‘ãƒ¼ãƒ„ãƒ©ãƒ™ãƒ«ã®å“ç•ªã‚’èª­ã¿å–ã£ã¦ãã ã•ã„");
  document.getElementById("firstCodeDisplay").textContent = "";
  document.getElementById("scanBtn").style.display = "block";
}

// ================= IndexedDB =================
function saveHistory(first, second, result) {
  const tx = db.transaction("records","readwrite");
  tx.objectStore("records").add({
    time: new Date().toLocaleString(),
    first, second, result
  });
  tx.oncomplete = loadHistory;
}

function loadHistory() {
  const tx = db.transaction("records","readonly");
  const req = tx.objectStore("records").getAll();
  req.onsuccess = () => {
    const table = document.getElementById("history");
    table.innerHTML = "<tr><th>æ™‚åˆ»</th><th>1å›ç›®</th><th>2å›ç›®</th><th>çµæœ</th></tr>";
    req.result.slice(-5).reverse().forEach(r=>{
      table.innerHTML += `<tr>
        <td>${r.time}</td><td>${r.first}</td><td>${r.second}</td><td>${r.result}</td>
      </tr>`;
    });
  };
}

// ================= CSV =================
function downloadCSV() {
  const tx = db.transaction("records","readonly");
  const req = tx.objectStore("records").getAll();
  req.onsuccess = () => {
    let csv = "æ™‚åˆ»,1å›ç›®,2å›ç›®,çµæœ\n";
    req.result.forEach(r=>{
      csv += `${r.time},${r.first},${r.second},${r.result}\n`;
    });
    const blob = new Blob([csv],{type:"text/csv"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "barcode_history.csv";
    a.click();
  };
}

// ================= ã‚¤ãƒ™ãƒ³ãƒˆ =================
scanBtn.onclick = startScan;
resetBtn.onclick = resetAll;
csvBtn.onclick = downloadCSV;

document.getElementById("maintenanceOverlay").onclick = () => {
  document.getElementById("maintenanceOverlay").style.display = "none";
};
</script>

</body>
</html>
