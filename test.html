<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>æµ·å¤–ãƒ©ãƒ™ãƒ«è²¼ã‚Šæ¤œå“</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family:-apple-system,BlinkMacSystemFont; padding:20px; margin-bottom:80px; }
#status { padding:20px; font-size:24px; font-weight:bold; border-radius:12px; text-align:center; margin-bottom:10px; }
.ok { background:green; color:white; }
.ng { background:red; color:white; }
.normal { background:#e5e5e5; color:#0066cc; }

#firstCodeDisplay { font-size:20px; margin-bottom:20px; font-weight:bold; }

#video-container { position:relative; width:100%; max-width:400px; margin:auto; }
video { width:100%; border-radius:10px; background:#000; }

#scan-frame {
  width:260px; height:160px;
  border:3px solid rgba(255,0,0,.8);
  position:absolute;
  top:50%; left:50%;
  transform:translate(-50%,-50%);
  pointer-events:none;
  border-radius:10px;
}

button { width:100%; font-size:20px; padding:15px; margin-top:20px; border-radius:10px; }

table { width:100%; margin-top:20px; border-collapse:collapse; }
th,td { border-bottom:1px solid #ddd; padding:8px; }

.navbar {
  position:fixed; bottom:0; left:0;
  width:100%; background:#f3f3f3;
  border-top:2px solid #ccc;
  display:flex;
}
.navbar a {
  flex:1; text-align:center;
  padding:15px 0; font-size:18px;
  text-decoration:none; color:#333;
}
.navbar a.active {
  background:#0078ff; color:white; font-weight:bold;
}

/* ===== æ”¹ä¿®ä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ ===== */
#maintenanceOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  color: #fff;
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
}
#maintenanceOverlay .overlay-content {
  padding: 30px;
  border-radius: 12px;
  background: #222;
  max-width: 90%;
}
#maintenanceOverlay .tap {
  margin-top: 20px;
  font-size: 18px;
  font-weight: bold;
  color: #4da3ff;
}
</style>
</head>

<div id="maintenanceOverlay">
  <div class="overlay-content">
    <h2>ç¾åœ¨æ”¹ä¿®ä¸­ã§ã™</h2>
    <p>â–¶ ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã—ã¦èµ·å‹•</p>
  </div>
</div>

<body>

<h2>æµ·å¤–ãƒ©ãƒ™ãƒ«è²¼ã‚Šæ¤œå“</h2>

<div id="status" class="normal">æµ·å¤–ãƒ‘ãƒ¼ãƒ„ãƒ©ãƒ™ãƒ«ã®å“ç•ªã‚’èª­ã¿å–ã£ã¦ãã ã•ã„</div>
<div id="firstCodeDisplay"></div>

<div id="video-container">
  <video id="video" playsinline></video>
  <div id="scan-frame"></div>
</div>

<button id="scanBtn">ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹</button>
<button id="resetBtn">ğŸ”„ æœ€åˆã«æˆ»ã‚‹</button>
<button id="csvBtn">ğŸ“„ CSVå‡ºåŠ›</button>

<h3>å±¥æ­´ï¼ˆæœ€æ–°5ä»¶ï¼‰</h3>
<table id="history"></table>

<div class="navbar">
  <a href="index.html">ğŸ“· QRæ¤œå“</a>
  <a href="tenyuryoku.html">âŒ¨ æ‰‹å…¥åŠ›æ¤œå“</a>
  <a href="scan.html" class="active">ğŸ·ï¸ æµ·å¤–ãƒ©ãƒ™ãƒ«</a>
</div>

<script>
// ================= IndexedDB =================
let db;
const req = indexedDB.open("barcodeDB",1);
req.onupgradeneeded = e=>{
  db=e.target.result;
  db.createObjectStore("records",{keyPath:"id",autoIncrement:true});
};
req.onsuccess = e=>{
  db=e.target.result;
  loadHistory();
};

// ================= éŸ³ =================
const readSound=new Audio("sounds/yomitori.mp3");
const successSound=new Audio("sounds/seikou.mp3");
const errorSound=new Audio("sounds/keikoku.mp3");

// ================= å¤‰æ•° =================
let step=1;
let firstCode="";
let scanning=false;
let stream=null;

const video=document.getElementById("video");
const frame=document.getElementById("scan-frame");

// ================= è¡¨ç¤º =================
function setStatus(t,c="normal"){
  status.textContent=t;
  status.className=c;
}

// ================= ã‚«ãƒ¡ãƒ©èµ·å‹• =================
async function startScan(){
  if(scanning) return;
  scanning=true;

  if(!("BarcodeDetector" in window)){
    alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯BarcodeDetectorã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“");
    scanning=false;
    return;
  }

  stream = await navigator.mediaDevices.getUserMedia({
    video:{ facingMode:{ ideal:"environment" } }
  });
  video.srcObject=stream;
  await video.play();

  const detector = new BarcodeDetector({
    formats:["code_128","code_39","ean_13","ean_8","itf"]
  });

  scanLoop(detector);
}

// ================= èª­ã¿å–ã‚Šãƒ«ãƒ¼ãƒ— =================
async function scanLoop(detector){
  if(!scanning) return;

  const barcodes = await detector.detect(video);
  if(barcodes.length){
    handleScan(barcodes[0].rawValue);
    return;
  }
  requestAnimationFrame(()=>scanLoop(detector));
}

// ================= åœæ­¢ =================
function stopCamera(){
  scanning=false;
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
  }
  video.srcObject=null;
}

// ================= åˆ¤å®š =================
function handleScan(code){
  stopCamera();
  readSound.play();

  const v=code.trim();

  if(step===1){
    if(v.length>7){
      errorSound.play();
      setStatus("âŒ 1å›ç›®ã¯7æ–‡å­—ä»¥ä¸‹","ng");
      return;
    }
    firstCode=v;
    firstCodeDisplay.textContent="1å›ç›®ã®ã‚³ãƒ¼ãƒ‰ : "+v;
    setStatus("æµ·å¤–ãƒ‘ãƒ¼ãƒ„ãƒ©ãƒ™ãƒ«ã®å“ç•ªã‚’èª­ã¿å–ã£ã¦ãã ã•ã„");
    step=2;
    return;
  }

  if(step===2){
    const ok=v.includes(firstCode);
    setStatus(ok?"âœ” ä¸€è‡´ã—ã¾ã—ãŸï¼":"âŒ ä¸ä¸€è‡´ã§ã™",ok?"ok":"ng");
    saveHistory(firstCode,v,ok?"OK":"NG");
    scanBtn.style.display="none";
    step=3;
  }
}

// ================= ãƒªã‚»ãƒƒãƒˆ =================
function resetAll(){
  stopCamera();
  step=1;
  firstCode="";
  setStatus("æµ·å¤–ãƒ‘ãƒ¼ãƒ„ãƒ©ãƒ™ãƒ«ã®å“ç•ªã‚’èª­ã¿å–ã£ã¦ãã ã•ã„");
  firstCodeDisplay.textContent="";
  scanBtn.style.display="block";
}

// ================= å±¥æ­´ =================
function saveHistory(first,second,result){
  const tx=db.transaction("records","readwrite");
  tx.objectStore("records").add({
    time:new Date().toLocaleString(),
    first,second,result
  });
  tx.oncomplete=loadHistory;
}

function loadHistory(){
  const tx=db.transaction("records","readonly");
  const r=tx.objectStore("records").getAll();
  r.onsuccess=()=>{
    history.innerHTML="<tr><th>æ™‚åˆ»</th><th>1å›ç›®</th><th>2å›ç›®</th><th>çµæœ</th></tr>";
    r.result.slice(-5).reverse().forEach(d=>{
      history.innerHTML+=`<tr><td>${d.time}</td><td>${d.first}</td><td>${d.second}</td><td>${d.result}</td></tr>`;
    });
  };
}

// ================= CSV =================
csvBtn.onclick=()=>{
  const tx=db.transaction("records","readonly");
  const r=tx.objectStore("records").getAll();
  r.onsuccess=()=>{
    let csv="æ™‚åˆ»,1å›ç›®,2å›ç›®,çµæœ\n";
    r.result.forEach(d=>{
      csv+=`${d.time},${d.first},${d.second},${d.result}\n`;
    });
    const a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
    a.download="barcode_history.csv";
    a.click();
  };
};

scanBtn.onclick=startScan;
resetBtn.onclick=resetAll;

// ===== ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ =====
maintenanceOverlay.onclick=()=>{
  maintenanceOverlay.style.display="none";
};
</script>

</body>
</html>
