<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>QRæ¤œå“ã‚·ã‚¹ãƒ†ãƒ </title>
<style>
body { font-family: sans-serif; text-align: center; background: #f5f5f5; margin: 0; padding: 20px; }
video { width: 90%; border-radius: 10px; margin-top: 10px; }
canvas { display: none; }
#scanArea { 
  width: 80%; height: 200px; margin: 10px auto;
  border: 3px solid red; box-sizing: border-box;
}
table { width: 90%; margin: 20px auto; border-collapse: collapse; background: white; }
th, td { border: 1px solid #ccc; padding: 10px; }
th { background: #eee; }
.success { background: lightgreen; }
.fail { background: pink; }
</style>
</head>
<body>

<h2>ğŸ“¦ QRã‚³ãƒ¼ãƒ‰æ¤œå“ã‚·ã‚¹ãƒ†ãƒ </h2>

<div id="scanArea"></div>
<video id="camera" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<button onclick="downloadCSV()">ğŸ“¥ CSVå‡ºåŠ›</button>

<table>
<thead>
<tr><th>QRã‚³ãƒ¼ãƒ‰</th><th>ã‚«ã‚¦ãƒ³ãƒˆ</th><th>çŠ¶æ…‹</th></tr>
</thead>
<tbody id="list"></tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<script>
const video = document.getElementById("camera");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const scanArea = document.getElementById("scanArea");
const listTable = document.getElementById("list");

let items = {}; // { code: count }
let scanning = true;

// ã‚«ãƒ¡ãƒ©èµ·å‹•
navigator.mediaDevices.getUserMedia({
  video: { facingMode: "environment" }
})
.then(stream => {
  video.srcObject = stream;
})
.catch(err => alert("ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err));

// QRèª­ã¿å–ã‚Šãƒ«ãƒ¼ãƒ—
function scan() {
  if (!scanning) return;

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const qr = jsQR(imageData.data, canvas.width, canvas.height);

  if (qr) {
    handleScan(qr.data);
    scanning = false;
    setTimeout(()=> scanning = true, 1500);
  }

  requestAnimationFrame(scan);
}
requestAnimationFrame(scan);


// èª­ã¿å–ã£ãŸã‚³ãƒ¼ãƒ‰å‡¦ç†
function handleScan(code) {
  let state = "æ–°è¦ç™»éŒ²";

  if (items[code]) {
    items[code].count++;
    state = "ä¸€è‡´ (æ¤œå“OK)";
  } else {
    items[code] = { count: 1 };
  }

  updateTable();

  //åŠ¹æœéŸ³ãƒ»ãƒã‚¤ãƒ–
  navigator.vibrate?.(200);
  new Audio("https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg").play()
    .catch(() => {});

}

// è¡¨æ›´æ–°
function updateTable() {
  listTable.innerHTML = "";
  for (let code in items) {
    let tr = document.createElement("tr");
    tr.className = items[code].count > 1 ? "success" : "fail";
    tr.innerHTML = `<td>${code}</td><td>${items[code].count}</td><td>${items[code].count > 1 ? "OK" : "æœªæ¤œå“"}</td>`;
    listTable.appendChild(tr);
  }
}

// CSVå‡ºåŠ›
function downloadCSV() {
  let csv = "code,count,status\n";
  for (let code in items) {
    csv += `${code},${items[code].count},${items[code].count > 1 ? "OK" : "æœªæ¤œå“"}\n`;
  }

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "inspection_result.csv";
  a.click();

  URL.revokeObjectURL(url);
}
</script>

</body>
</html>
