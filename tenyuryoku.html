<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>æ‰‹å…¥åŠ›æ¤œå“</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { 
  font-family: -apple-system, BlinkMacSystemFont; 
  padding: 20px; background:#ffffff; 
  margin-bottom: 90px;
}

#status { padding: 20px; font-size: 22px; font-weight: bold; border-radius: 10px; text-align: center; margin-bottom: 20px; }
.ok { background: green; color: white; }
.ng { background: red; color: white; }
.normal { background: #e5e5e5; color: #0066cc; }

input { width: 90%; font-size: 24px; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #888; }
button { width: 100%; font-size: 20px; padding: 15px; margin-top: 10px; border-radius: 10px; }

table { width: 100%; margin-top: 20px; border-collapse: collapse; background:white; }
th, td { border-bottom: 1px solid #ddd; padding: 6px; }

#video-container { position: relative; width: 100%; max-width: 400px; margin: auto; }
video { width: 100%; border-radius: 10px; }

#scan-frame {
  width: 220px;
  height: 220px;
  border: 3px solid rgba(255,0,0,0.8);
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
  border-radius: 10px;
}

.navbar {
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  background:#f3f3f3;
  border-top:2px solid #ccc;
  display:flex;
  justify-content:space-around;
}
.navbar a {
  flex:1;
  text-align:center;
  padding:15px 0;
  text-decoration:none;
  color:#333;
}
.navbar a.active {
  background:#0078ff;
  color:white;
  font-weight:bold;
}

body { overflow-x: hidden; }

#history {
  width: 100%;
  max-width: 100%;
  table-layout: fixed;
}
#history th,
#history td {
  max-width: 0;
  word-break: break-all;
  overflow-wrap: anywhere;
  white-space: normal;
  overflow: hidden;
}
#history th:nth-child(3),
#history td:nth-child(3) {
  font-size: 12px;
  line-height: 1.3;
}
#history td:nth-child(3) {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
</style>
</head>

<body>

<h2>æ‰‹å…¥åŠ›æ¤œå“ã‚·ã‚¹ãƒ†ãƒ </h2>

<div id="status" class="normal">â‘  æœ€åˆã«å“ç•ªãƒ»å‹å¼ã‚’æ‰‹å…¥åŠ›ã—ã¦ãã ã•ã„</div>
<input id="manualInput" type="text" placeholder="ä¾‹ï¼šABC123" maxlength="50">

<div id="video-container">
  <video id="camera" autoplay playsinline></video>
  <div id="scan-frame"></div>
</div>

<button id="startScanBtn">ğŸ“· QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹</button>
<button id="resetBtn">ğŸ”„ æœ€åˆã«æˆ»ã‚‹</button>
<button id="exportBtn">ğŸ“ CSVå‡ºåŠ›</button>

<h3>å±¥æ­´</h3>
<table id="history"></table>

<div class="navbar">
  <a href="index.html">ğŸ“· QRæ¤œå“</a>
  <a href="tenyuryoku.html" class="active">âŒ¨ æ‰‹å…¥åŠ›æ¤œå“</a>
  <a href="scan.html">ğŸ·ï¸ æµ·å¤–ãƒ©ãƒ™ãƒ«</a>
</div>

<script src="js/jsQR.js"></script>

<script>
// ========= æ¤œå“ç”¨å¤‰æ•° =========
let firstInput = "";
let scanning = false;
let detected = false;

/* ========= AudioContextï¼ˆAndroidå®Œå…¨å¯¾ç­–ï¼‰ ========= */
let audioCtx;
let soundBuffers = {};
let audioReady = false;

async function initAudio() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioCtx.state === "suspended") {
    await audioCtx.resume();
  }

  const files = {
    ok: "sounds/seikou.mp3",
    ng: "sounds/keikoku.mp3"
  };

  for (const k in files) {
    const res = await fetch(files[k]);
    const buf = await res.arrayBuffer();
    soundBuffers[k] = await audioCtx.decodeAudioData(buf);
  }

  audioReady = true;
}

function playSound(type) {
  if (!audioReady || !soundBuffers[type]) return;
  const src = audioCtx.createBufferSource();
  src.buffer = soundBuffers[type];
  src.connect(audioCtx.destination);
  src.start(0);
}

/* ========= IndexedDB ========= */
let db;
const req = indexedDB.open("QR_Inspection_DB", 1);

req.onupgradeneeded = e => {
  db = e.target.result;
  db.createObjectStore("records", { keyPath: "id", autoIncrement: true });
};
req.onsuccess = e => {
  db = e.target.result;
  loadHistory();
};

function saveResult(first, scanned, result) {
  const tx = db.transaction("records", "readwrite");
  tx.objectStore("records").add({
    time: new Date().toLocaleString(),
    first,
    scanned,
    result
  });
  setTimeout(loadHistory, 300);
}

/* ========= UI ========= */
function setStatus(text, type="normal") {
  const s = document.getElementById("status");
  s.textContent = text;
  s.className = type;
}

/* ========= ã‚«ãƒ¡ãƒ© ========= */
const video = document.getElementById("camera");

async function startScan() {
  if (!firstInput) return alert("å…ˆã«æ‰‹å…¥åŠ›ã—ã¦ãã ã•ã„");

  await initAudio(); // â˜… ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œæ™‚ã«å¿…ãšéŸ³ã‚’å¾©å¸°

  if (scanning) return;
  scanning = true;
  detected = false;

  const stream = await navigator.mediaDevices.getUserMedia({
    video: {
      facingMode: { ideal: "environment" },
      width: { ideal: 1920 },
      height: { ideal: 1080 },
      advanced: [{ zoom: 2 }]
    }
  });

  video.srcObject = stream;
  setStatus("æ å†…ã«QRã‚³ãƒ¼ãƒ‰ã‚’åˆã‚ã›ã¦ãã ã•ã„","normal");
  requestAnimationFrame(scanLoop);
}

function stopCamera() {
  scanning = false;
  if (video.srcObject) video.srcObject.getTracks().forEach(t=>t.stop());
  video.srcObject = null;
}

/* ========= QRå‡¦ç† ========= */
function scanLoop() {
  if (!scanning || detected) return;

  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");

  const frame = document.getElementById("scan-frame").getBoundingClientRect();
  const rect = video.getBoundingClientRect();

  canvas.width = frame.width;
  canvas.height = frame.height;

  const scaleX = video.videoWidth / rect.width;
  const scaleY = video.videoHeight / rect.height;

  ctx.drawImage(video,
    (frame.left - rect.left) * scaleX,
    (frame.top - rect.top) * scaleY,
    frame.width * scaleX,
    frame.height * scaleY,
    0,0,canvas.width,canvas.height
  );

  const img = ctx.getImageData(0,0,canvas.width,canvas.height);
  const qr = jsQR(img.data, canvas.width, canvas.height);

  if (qr) {
    detected = true;
    stopCamera();
    compare(qr.data);
  } else {
    requestAnimationFrame(scanLoop);
  }
}

/* ========= åˆ¤å®š ========= */
function compare(scanned) {
  if (scanned.includes(firstInput)) {
    setStatus("âœ” ä¸€è‡´ã—ã¾ã—ãŸï¼", "ok");
    playSound("ok");
    saveResult(firstInput, scanned, "OK");
  } else {
    setStatus("âŒ ä¸ä¸€è‡´ã§ã™", "ng");
    playSound("ng");
    saveResult(firstInput, scanned, "NG");
  }
}

/* ========= å…¥åŠ›åˆ¶å¾¡ ========= */
document.getElementById("manualInput").addEventListener("input", e => {
  let v = e.target.value;

  if (/[^\x20-\x7E]/.test(v)) {
    setStatus("âŒ å…¨è§’ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“", "ng");
    firstInput = "";
    return;
  }
  if (/[a-z]/.test(v)) {
    setStatus("âŒ å°æ–‡å­—ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“", "ng");
    firstInput = "";
    return;
  }
  if (v.length < 6) {
    setStatus("âŒ åŠè§’6æ–‡å­—ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„", "ng");
    firstInput = "";
    return;
  }

  firstInput = v;
  setStatus("æ¬¡ã«QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„","normal");
});

/* ========= å±¥æ­´ ========= */
function loadHistory() {
  const tx = db.transaction("records","readonly");
  const req = tx.objectStore("records").getAll();

  req.onsuccess = () => {
    const table = document.getElementById("history");
    table.innerHTML = "<tr><th>æ™‚åˆ»</th><th>å…¥åŠ›</th><th>QR</th><th>çµæœ</th></tr>";
    req.result.reverse().slice(0,5).forEach(r=>{
      table.innerHTML += `<tr><td>${r.time}</td><td>${r.first}</td><td>${r.scanned}</td><td>${r.result}</td></tr>`;
    });
  };
}

/* ========= CSV ========= */
document.getElementById("exportBtn").addEventListener("click", ()=>{
  const tx = db.transaction("records","readonly");
  const req = tx.objectStore("records").getAll();
  req.onsuccess = ()=>{
    const rows=[["æ™‚åˆ»","å…¥åŠ›å€¤","QRå€¤","çµæœ"], ...req.result.map(r=>[r.time,r.first,r.scanned,r.result])];
    const blob = new Blob([rows.join("\n")],{type:"text/csv"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "æ¤œå“çµæœ.csv";
    a.click();
  };
});

/* ========= ãƒœã‚¿ãƒ³ ========= */
document.getElementById("startScanBtn").addEventListener("click", startScan);
document.getElementById("resetBtn").addEventListener("click", resetAll);

function resetAll() {
  stopCamera();
  firstInput = "";
  scanning = false;
  detected = false;
  document.getElementById("manualInput").value = "";
  setStatus("â‘  æœ€åˆã«å“ç•ªãƒ»å‹å¼ã‚’æ‰‹å…¥åŠ›ã—ã¦ãã ã•ã„", "normal");
}

/* ========= ã‚¹ãƒªãƒ¼ãƒ—å¾©å¸°å¯¾ç­– ========= */
document.addEventListener("visibilitychange", async () => {
  if (document.visibilityState === "visible") {
    audioReady = false;
    await initAudio();
  }
});
</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
