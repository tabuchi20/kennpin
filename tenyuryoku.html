<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>æ‰‹å…¥åŠ›æ¤œå“</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { 
  font-family: -apple-system, BlinkMacSystemFont; 
  padding: 20px; background:#ffffff; 
  margin-bottom: 90px;
}

#status { padding: 20px; font-size: 22px; font-weight: bold; border-radius: 10px; text-align: center; margin-bottom: 20px; }
.ok { background: green; color: white; }
.ng { background: red; color: white; }
.normal { background: #e5e5e5; color: #0066cc; }

input { width: 90%; font-size: 24px; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #888; }
button { width: 100%; font-size: 20px; padding: 15px; margin-top: 10px; border-radius: 10px; }

table { width: 100%; margin-top: 20px; border-collapse: collapse; background:white; }
th, td { border-bottom: 1px solid #ddd; padding: 6px; vertical-align: top; }

#video-container { position: relative; width: 100%; max-width: 400px; margin: auto; }
video { width: 100%; border-radius: 10px; }

#scan-frame {
  width: 220px;
  height: 220px;
  border: 3px solid rgba(255,0,0,0.8);
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
  border-radius: 10px;
}

/* ===== ãƒ•ãƒƒã‚¿ãƒ¼ ===== */
.navbar {
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  background:#f3f3f3;
  border-top:2px solid #ccc;
  display:flex;
}

.navbar a {
  flex:1;
  text-align:center;
  padding:15px 0;
  font-size:15px;
  text-decoration:none;
  color:#333;
}

.navbar a.active {
  background:#0078ff;
  color:white;
  font-weight:bold;
}

/* ===== Androidæ¨ªã¯ã¿å‡ºã—é˜²æ­¢ ===== */
body { overflow-x: hidden; }

/* ===== å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ä¿®æ­£ ===== */
#history {
  table-layout: auto; /* â† fixedã‚’ã‚„ã‚ã‚‹ */
}

#history th:nth-child(3),
#history td:nth-child(3) {
  font-size: 12px;          /* QRåˆ—ã ã‘å°ã•ã */
  word-break: break-all;
}
</style>
</head>

<body>

<h2>æ‰‹å…¥åŠ›æ¤œå“ã‚·ã‚¹ãƒ†ãƒ </h2>

<div id="status" class="normal">â‘  æœ€åˆã«å“ç•ªãƒ»å‹å¼ã‚’æ‰‹å…¥åŠ›ã—ã¦ãã ã•ã„</div>
<input id="manualInput" type="text" placeholder="ä¾‹ï¼šABC123" maxlength="50">

<div id="video-container">
  <video id="camera" autoplay playsinline></video>
  <div id="scan-frame"></div>
</div>

<button id="startScanBtn">ğŸ“· QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹</button>
<button id="resetBtn">ğŸ”„ æœ€åˆã«æˆ»ã‚‹</button>
<button id="exportBtn">ğŸ“ CSVå‡ºåŠ›</button>

<h3>å±¥æ­´</h3>
<table id="history"></table>

<div class="navbar">
  <a href="index.html">ğŸ“· QRæ¤œå“</a>
  <a href="tenyuryoku.html" class="active">âŒ¨ æ‰‹å…¥åŠ›æ¤œå“</a>
  <a href="scan.html">ğŸ·ï¸ æµ·å¤–ãƒ©ãƒ™ãƒ«</a>
</div>

<script src="js/jsQR.js"></script>

<script>
let firstInput = "";
let scanning = false;
let detected = false;

const beepOk = new Audio("sounds/seikou.mp3");
const beepNg = new Audio("sounds/keikoku.mp3");

let db;
const req = indexedDB.open("QR_Inspection_DB", 1);

req.onupgradeneeded = e => {
  db = e.target.result;
  db.createObjectStore("records", { keyPath: "id", autoIncrement: true });
};

req.onsuccess = e => {
  db = e.target.result;
  loadHistory();
};

function saveResult(first, scanned, result) {
  const tx = db.transaction("records", "readwrite");
  tx.objectStore("records").add({
    time: new Date().toLocaleString(),
    first,
    scanned,
    result
  });
  setTimeout(loadHistory, 300);
}

function setStatus(text, type="normal") {
  const s = document.getElementById("status");
  s.textContent = text;
  s.className = type;
}

/* ===== å±¥æ­´è¡¨ç¤ºï¼ˆQRã‚’40æ–‡å­—ã«åˆ¶é™ï¼‰ ===== */
function loadHistory() {
  const tx = db.transaction("records","readonly");
  const req = tx.objectStore("records").getAll();

  req.onsuccess = () => {
    const table = document.getElementById("history");
    table.innerHTML = "<tr><th>æ™‚åˆ»</th><th>å…¥åŠ›</th><th>QR</th><th>çµæœ</th></tr>";

    req.result.reverse().slice(0,5).forEach(r => {
      const qrShort = r.scanned.length > 40
        ? r.scanned.slice(0,40) + "â€¦"
        : r.scanned;

      table.innerHTML += `
        <tr>
          <td>${r.time}</td>
          <td>${r.first}</td>
          <td title="${r.scanned}">${qrShort}</td>
          <td>${r.result}</td>
        </tr>
      `;
    });
  };
}
</script>

</body>
</html>
