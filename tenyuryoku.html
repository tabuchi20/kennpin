<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>QRæ¤œå“ï¼ˆæ‰‹å‹•ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ + å®‰å®šèª­ã¿å–ã‚Šï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: -apple-system, BlinkMacSystemFont; padding: 20px; }
#status { padding: 20px; font-size: 22px; font-weight: bold; border-radius: 10px; text-align: center; margin-bottom: 20px; }
.ok { background: green; color: white; }
.ng { background: red; color: white; }
.normal { background: #e8e8e8; color: #003366; }
input { width: 100%; font-size: 24px; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #888; }
button { width: 100%; font-size: 20px; padding: 15px; margin-top: 10px; border-radius: 10px; }

#video-container { position: relative; width: 100%; max-width: 400px; margin: auto; }
video { width: 100%; border-radius: 10px; }

#scan-frame {
    width: 220px; height: 220px;
    border: 3px solid rgba(255,0,0,0.8);
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
    border-radius: 10px;
}
</style>
</head>
<body>

<h2>ğŸ“¦ QRæ¤œå“ã‚·ã‚¹ãƒ†ãƒ ï¼ˆå®‰å®šç‰ˆï¼‰</h2>

<div id="status" class="normal">1å›ç›®ã®ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>

<input id="manualInput" type="text" placeholder="ä¾‹ï¼š1234567890" autofocus maxlength="30">

<div id="video-container">
    <video id="camera" autoplay playsinline></video>
    <div id="scan-frame"></div>
</div>

<button id="startScanBtn">ğŸ“· 2å›ç›® QRèª­ã¿å–ã‚Šé–‹å§‹</button>
<button id="resetBtn">ãƒªã‚»ãƒƒãƒˆ</button>
<button id="exportBtn">CSVå‡ºåŠ›</button>

<h3>å±¥æ­´</h3>
<table id="history"></table>

<script src="https://unpkg.com/@zxing/library@latest"></script>

<script>
// ===== çŠ¶æ…‹ç®¡ç† =====
let firstInput = "";
let scanning = false;
let detected = false;
let currentTrack = null;
const reader = new ZXing.BrowserMultiFormatReader();

// ===== éŸ³ =====
const readSound = new Audio("sounds/yomitori.mp3");
const successSound = new Audio("sounds/seikou.mp3");
const errorSound = new Audio("sounds/keikoku.mp3");

// ===== IndexedDB =====
let db;
const req = indexedDB.open("checksDB_manual", 1);
req.onupgradeneeded = e => {
    db = e.target.result;
    db.createObjectStore("checks", { keyPath: "id", autoIncrement: true });
};
req.onsuccess = e => {
    db = e.target.result;
    loadHistory();
};

// ===== UI =====
function setStatus(msg, type="normal"){
    const s = document.getElementById("status");
    s.textContent = msg;
    s.className = type;
}

// ===== ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹ =====
async function startScan(){

    if(!firstInput) return alert("å…ˆã«ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

    detected = false;
    scanning = true;

    try{
        await reader.decodeFromVideoDevice(
            undefined,
            "camera",
            (result, err) => {
                if(!result || detected) return;
                detected = true;
                processScan(result.text);
            }
        );

        const stream = document.getElementById("camera").srcObject;
        currentTrack = stream.getVideoTracks()[0];

        setStatus("ğŸ“Œ QRã‚’æ ã«åˆã‚ã›ã¦ãã ã•ã„");

    }catch(e){
        alert("ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼: " + e.message);
        scanning=false;
    }
}

// ===== åˆ¤å®šå‡¦ç† =====
function processScan(code){
    readSound.play();
    stopScan();

    const ok = code.includes(firstInput);

    if(ok){
        successSound.play();
        setStatus("âœ” ä¸€è‡´ã—ã¾ã—ãŸï¼","ok");
    } else {
        errorSound.play();
        setStatus("âŒ ä¸ä¸€è‡´: "+code,"ng");
    }

    saveResult(firstInput, code, ok?"OK":"NG");
    loadHistory();
}

// ===== ã‚«ãƒ¡ãƒ©åœæ­¢ =====
function stopScan(){
    scanning = false;
    reader.reset();
}

// ===== æ‰‹å‹•ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ï¼ˆã‚¿ãƒƒãƒ—ï¼‰ =====
document.getElementById("camera").addEventListener("click", async ()=>{

    if(!currentTrack) return;
    const caps = currentTrack.getCapabilities();

    if(!caps.focusDistance) return; // å¯¾å¿œã—ã¦ã„ãªã„ç«¯æœ«

    setStatus("ğŸ”§ ãƒ”ãƒ³ãƒˆèª¿æ•´ä¸­...");

    await currentTrack.applyConstraints({
        advanced: [{ focusMode: "manual", focusDistance: caps.focusDistance.min }]
    });

    setTimeout(()=> setStatus("ğŸ“Œ QRã‚’æ ã«åˆã‚ã›ã¦ãã ã•ã„"), 800);
});

// ===== æ‰‹å‹•å…¥åŠ› =====
manualInput.addEventListener("change",()=>{
    firstInput = manualInput.value.trim();
    if(firstInput) setStatus("æ¬¡ã«QRã‚’èª­ã¿å–ã£ã¦ãã ã•ã„");
});

// ===== ä¿å­˜ =====
function saveResult(a,b,c){
    db.transaction("checks","readwrite").objectStore("checks")
    .add({time:new Date().toLocaleString(), first:a, second:b, result:c});
}

// ===== å±¥æ­´è¡¨ç¤º =====
function loadHistory(){
    const req = db.transaction("checks","readonly").objectStore("checks").getAll();
    req.onsuccess = ()=>{
        const table = document.getElementById("history");
        table.innerHTML = `<tr><th>æ™‚åˆ»</th><th>å…¥åŠ›</th><th>QR</th><th>çµæœ</th></tr>`;
        req.result.reverse().slice(0,20).forEach(r=>{
            table.innerHTML += `<tr><td>${r.time}</td><td>${r.first}</td><td>${r.second}</td><td>${r.result}</td></tr>`;
        });
    };
}

// ===== CSV =====
exportBtn.onclick=()=>{
    db.transaction("checks","readonly").objectStore("checks").getAll().onsuccess=e=>{
        const rows=[["æ™‚åˆ»","å…¥åŠ›","QR","çµæœ"],...e.result.map(r=>[r.time,r.first,r.second,r.result])];
        const a=document.createElement("a");
        a.href=URL.createObjectURL(new Blob([rows.map(r=>r.join(",")).join("\n")]));
        a.download="æ¤œå“å±¥æ­´.csv";
        a.click();
    };
};

// ===== æ“ä½œ =====
startScanBtn.onclick=startScan;
resetBtn.onclick=()=>location.reload();
</script>

</body>
</html>
