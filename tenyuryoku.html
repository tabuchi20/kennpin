<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>æ‰‹å…¥åŠ›æ¤œå“</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { 
  font-family: -apple-system, BlinkMacSystemFont; 
  padding: 20px; background:#ffffff; 
  margin-bottom: 90px;
}

#status { padding: 20px; font-size: 22px; font-weight: bold; border-radius: 10px; text-align: center; margin-bottom: 20px; }
.ok { background: green; color: white; }
.ng { background: red; color: white; }
.normal { background: #e5e5e5; color: #0066cc; }

input { width: 90%; font-size: 24px; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #888; }
button { width: 100%; font-size: 20px; padding: 15px; margin-top: 10px; border-radius: 10px; }

table { width: 100%; margin-top: 20px; border-collapse: collapse; background:white; }
th, td { border-bottom: 1px solid #ddd; padding: 6px; }

#video-container { position: relative; width: 100%; max-width: 400px; margin: auto; }
video { width: 100%; border-radius: 10px; }

#scan-frame {
  width: 220px;
  height: 220px;
  border: 3px solid rgba(255,0,0,0.8);
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
  border-radius: 10px;
}

/* ===== å…±é€šãƒ•ãƒƒã‚¿ãƒ¼ãƒŠãƒ“ ===== */
.navbar {
    position:fixed;
    bottom:0;
    left:0;
    width:100%;
    background:#f3f3f3;
    border-top:2px solid #ccc;
    display:flex;
    justify-content:space-around;
    z-index:9999;
}
.navbar a {
    flex:1;
    text-align:center;
    padding:15px 0;
    font-size:18px;
    text-decoration:none;
    color:#333;
}
.navbar a.active {
    background:#0078ff;
    color:white;
    font-weight:bold;
}
</style>
</head>
<body>

<h2>æ‰‹å…¥åŠ›æ¤œå“ã‚·ã‚¹ãƒ†ãƒ </h2>

<div id="status" class="normal">â‘  æœ€åˆã«å“ç•ªãƒ»å‹å¼ã‚’æ‰‹å…¥åŠ›ã—ã¦ãã ã•ã„</div>
<input id="manualInput" type="text" placeholder="ä¾‹ï¼šABC123" autofocus maxlength="50">

<div id="video-container">
  <video id="camera" autoplay playsinline></video>
  <div id="scan-frame"></div>
</div>

<button id="startScanBtn">ğŸ“· QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹</button>
<button id="resetBtn">ğŸ”„ æœ€åˆã«æˆ»ã‚‹</button>
<button id="exportBtn">ğŸ“ CSVå‡ºåŠ›</button>

<h3>å±¥æ­´</h3>
<table id="history"></table>

<!-- â–¼ ãƒ•ãƒƒã‚¿ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
<div class="navbar">
    <a href="index.html">ğŸ“· QRæ¤œå“</a>
    <a href="tenyuryoku.html" class="active">âŒ¨ æ‰‹å…¥åŠ›æ¤œå“</a>
  ã€€<a href="scan.html">ğŸ·ï¸ æµ·å¤–ãƒ©ãƒ™ãƒ«</a>
</div>

<script src="js/jsQR.js"></script>

<script>
// ========= æ¤œå“ç”¨å¤‰æ•° =========
let firstInput = "";
let scanning = false;
let detected = false;

// ========= éŸ³å£° =========
const beepOk = new Audio("sounds/seikou.mp3");
const beepNg = new Audio("sounds/keikoku.mp3");

// ========= IndexedDB =========
let db;
const req = indexedDB.open("QR_Inspection_DB", 1);

req.onupgradeneeded = e => {
  db = e.target.result;
  db.createObjectStore("records", { keyPath: "id", autoIncrement: true });
};

req.onsuccess = e => {
  db = e.target.result;
  loadHistory();
};

function saveResult(first, scanned, result) {
  const tx = db.transaction("records", "readwrite");
  tx.objectStore("records").add({
    time: new Date().toLocaleString(),
    first,
    scanned,
    result
  });
  setTimeout(loadHistory, 300);
}

// ========= UIåˆ¶å¾¡ =========
function setStatus(text, type="normal") {
  const s = document.getElementById("status");
  s.textContent = text;
  s.className = type;
}

// ========= ã‚«ãƒ¡ãƒ©å–å¾— =========
const video = document.getElementById("camera");

async function startScan() {
  if (!firstInput) return alert("å…ˆã«æ‰‹å…¥åŠ›ã—ã¦ãã ã•ã„");

  if (scanning) return;
  scanning = true;
  detected = false;

  try {
    const stream = await navigator.mediaDevices.getUserMedia({
     video: {
        facingMode: { ideal: "environment" },
        width: { ideal: 1920 },
        height: { ideal: 1080 },
        advanced: [{ zoom: 2 }]
      }
    });

    video.srcObject = stream;
    setStatus("æ å†…ã«QRã‚³ãƒ¼ãƒ‰ã‚’åˆã‚ã›ã¦ãã ã•ã„","normal");
    requestAnimationFrame(scanLoop);

  } catch (e) {
    alert("ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼ï¼š" + e.message);
  }
}

function stopCamera() {
  scanning = false;
  if (video.srcObject) video.srcObject.getTracks().forEach(t=>t.stop());
  video.srcObject = null;
}

// ========= QRæ å†…ã‚¹ã‚­ãƒ£ãƒ³å‡¦ç† =========
function scanLoop() {
  if (!scanning || detected) return;

  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");

  const frame = document.getElementById("scan-frame").getBoundingClientRect();
  const rect = video.getBoundingClientRect();

  canvas.width = frame.width;
  canvas.height = frame.height;

  const scaleX = video.videoWidth / rect.width;
  const scaleY = video.videoHeight / rect.height;

  ctx.drawImage(video,
    (frame.left - rect.left) * scaleX,
    (frame.top - rect.top) * scaleY,
    frame.width * scaleX,
    frame.height * scaleY,
    0,0,canvas.width,canvas.height
  );

  const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
  const qr = jsQR(imageData.data, canvas.width, canvas.height);

  if (qr) {
    detected = true;
    stopCamera();
    compare(qr.data);
  } else {
    requestAnimationFrame(scanLoop);
  }
}

// ========= åˆ¤å®šå‡¦ç† =========
function compare(scanned) {
  if (scanned.includes(firstInput)) {
    setStatus("âœ” ä¸€è‡´ã—ã¾ã—ãŸï¼", "ok");
    beepOk.play();
    saveResult(firstInput, scanned, "OK");
  } else {
    setStatus("âŒ ä¸ä¸€è‡´ã§ã™" , "ng");
    beepNg.play();
    saveResult(firstInput, scanned, "NG");
  }
}

// ========= å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå¤§æ–‡å­—ï¼‹æ•°å­—ï¼‹è¨˜å·ã®ã¿ / å°æ–‡å­—ãƒ»å…¨è§’ç¦æ­¢ï¼‰ =========
document.getElementById("manualInput").addEventListener("input", e => {
  let v = e.target.value;

  // â˜… å…¨è§’ç¦æ­¢ï¼šASCII 0x20ã€œ0x7E ä»¥å¤–ã‚’æ’é™¤
  if (/[^\x20-\x7E]/.test(v)) {
    setStatus("âŒ å…¨è§’ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ï¼ˆåŠè§’ã®ã¿ï¼‰", "ng");
    firstInput = "";
    return;
  }

  // â˜… å°æ–‡å­—ç¦æ­¢
  if (/[a-z]/.test(v)) {
    setStatus("âŒ å°æ–‡å­—ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ï¼ˆå¤§æ–‡å­—ãƒ»æ•°å­—ãƒ»è¨˜å·ã®ã¿ï¼‰", "ng");
    firstInput = "";
    return;
  }

  // â˜… 6æ–‡å­—æœªæº€ç¦æ­¢
  if (v.length < 6) {
    setStatus("âŒ åŠè§’6æ–‡å­—ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„", "ng");
    firstInput = "";
    return;
  }

  // â˜… æ¡ä»¶ã‚¯ãƒªã‚¢
  firstInput = v;
  setStatus("æ¬¡ã«QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„","normal");
});

// ========= å±¥æ­´è¡¨ç¤ºï¼ˆæœ€æ–°5ä»¶ã¾ã§ï¼‰ =========
function loadHistory() {
  const tx = db.transaction("records","readonly");
  const req = tx.objectStore("records").getAll();

  req.onsuccess = () => {
    const table = document.getElementById("history");
    table.innerHTML = "<tr><th>æ™‚åˆ»</th><th>å…¥åŠ›</th><th>QR</th><th>çµæœ</th></tr>";

    req.result
      .reverse()
      .slice(0,5)
      .forEach(r=>{
        table.innerHTML += `
          <tr>
            <td>${r.time}</td>
            <td>${r.first}</td>
            <td>${r.scanned}</td>
            <td>${r.result}</td>
          </tr>
        `;
      });
  };
}

// ========= CSVå‡ºåŠ› =========
document.getElementById("exportBtn").addEventListener("click", ()=>{
  const tx = db.transaction("records","readonly");
  const req = tx.objectStore("records").getAll();

  req.onsuccess = ()=>{
    const rows=[["æ™‚åˆ»","å…¥åŠ›å€¤","QRå€¤","çµæœ"], ...req.result.map(r=>[r.time,r.first,r.scanned,r.result])];
    const blob = new Blob([rows.join("\n")],{type:"text/csv"});
    
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "æ¤œå“çµæœ.csv";
    a.click();
  };
});

// ========= ãƒœã‚¿ãƒ³ =========
document.getElementById("startScanBtn").addEventListener("click", startScan);
document.getElementById("resetBtn").addEventListener("click", resetAll);

function resetAll() {
  // ã‚«ãƒ¡ãƒ©åœæ­¢
  stopCamera();

  // å¤‰æ•°ãƒªã‚»ãƒƒãƒˆ
  firstInput = "";
  scanning = false;
  detected = false;

  // UIåˆæœŸåŒ–
  document.getElementById("manualInput").value = "";
  document.getElementById("manualInput").focus();

  setStatus("â‘  æœ€åˆã«å“ç•ªãƒ»å‹å¼ã‚’æ‰‹å…¥åŠ›ã—ã¦ãã ã•ã„", "normal");

  // æ ã‚’æˆ»ã™ï¼ˆå¿µã®ãŸã‚ï¼‰
  document.getElementById("scan-frame").style.display = "block";
}

</script>
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>






