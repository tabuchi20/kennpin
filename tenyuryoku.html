<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>QRæ¤œå“ï¼ˆiPhoneå¯¾å¿œå¼·åŒ–ç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: -apple-system, BlinkMacSystemFont; padding: 20px; }
#status { padding: 20px; font-size: 22px; font-weight: bold; border-radius: 10px; text-align: center; margin-bottom: 20px; }
.ok { background: green; color: white; }
.ng { background: red; color: white; }
.normal { background: #e8e8e8; color: #003366; }
input { width: 100%; font-size: 24px; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #888; }
button { width: 100%; font-size: 20px; padding: 15px; margin-top: 10px; border-radius: 10px; }
table { width: 100%; margin-top: 20px; border-collapse: collapse; }
th, td { border-bottom: 1px solid #ddd; padding: 6px; }

#video-container { position: relative; width: 100%; max-width: 400px; margin: auto; }
video { width: 100%; border-radius: 10px; }

#scan-frame {
    width: 220px;
    height: 220px;
    border: 3px solid rgba(255,0,0,0.8);
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
    border-radius: 10px;
}
</style>
</head>
<body>

<h2>QRæ¤œå“ã‚·ã‚¹ãƒ†ãƒ ï¼ˆiPhoneå¼·åŒ–ç‰ˆï¼‰</h2>

<div id="status" class="normal">1å›ç›®ã®ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>

<input id="manualInput" type="text" placeholder="ä¾‹ï¼š1234567890" autofocus maxlength="30">

<div id="video-container">
    <video id="camera" autoplay playsinline></video>
    <div id="scan-frame"></div>
</div>

<button id="startScanBtn">ğŸ“· 2å›ç›® QRèª­ã¿å–ã‚Šé–‹å§‹</button>
<button id="resetBtn">ãƒªã‚»ãƒƒãƒˆ</button>
<button id="exportBtn">CSVå‡ºåŠ›</button>

<h3>å±¥æ­´</h3>
<table id="history"></table>

<script src="https://unpkg.com/@zxing/library@latest"></script>

<script>
// ======== Safari / iPhoneå¯¾å¿œ Polyfill =========
if (!navigator.mediaDevices) navigator.mediaDevices = {};

if (!navigator.mediaDevices.getUserMedia) {
    navigator.mediaDevices.getUserMedia = function(constraints) {
        const getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
        if (!getUserMedia) {
            return Promise.reject(new Error("ãƒ–ãƒ©ã‚¦ã‚¶ãŒã‚«ãƒ¡ãƒ©ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“"));
        }
        return new Promise((resolve, reject) => getUserMedia.call(navigator, constraints, resolve, reject));
    };
}

// ======== çŠ¶æ…‹ç®¡ç† ========
let firstInput = "";
let scanning = false;
let detected = false;

// ZXing Reader
const reader = new ZXing.BrowserMultiFormatReader();

// ======== åŠ¹æœéŸ³ ========
const readSound = new Audio("sounds/yomitori.mp3");
const successSound = new Audio("sounds/seikou.mp3");
const errorSound = new Audio("sounds/keikoku.mp3");

// ======== IndexedDB ========
let db;
const req = indexedDB.open("checksDB_manual", 1);

req.onupgradeneeded = (e) => {
    db = e.target.result;
    db.createObjectStore("checks", { keyPath: "id", autoIncrement: true });
};
req.onsuccess = (e) => {
    db = e.target.result;
    loadHistory();
};

function setStatus(txt, type="normal") {
    const s = document.getElementById("status");
    s.textContent = txt;
    s.className = type;
}

// ======== ã‚«ãƒ¡ãƒ©åˆ¶å¾¡ ========
const video = document.getElementById("camera");
const scanFrame = document.getElementById("scan-frame");

async function startScan() {
    if (!firstInput) return alert("å…ˆã«ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");
    if (scanning) return;

    scanning = true;
    detected = false;

    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { ideal: "environment" } }
        });

        video.srcObject = stream;
        setStatus("ğŸ“Œ QRã‚³ãƒ¼ãƒ‰ã‚’æ ã«åˆã‚ã›ã¦ãã ã•ã„", "normal");

        requestAnimationFrame(scanLoop);

    } catch (err) {
        alert("âš  ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: " + err.message + "\nSafariã®ã‚«ãƒ¡ãƒ©è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        stopCamera();
    }
}

function stopCamera() {
    scanning = false;
    const stream = video.srcObject;
    if (stream) stream.getTracks().forEach(t => t.stop());
    video.srcObject = null;
}

// ======== ã‚¹ã‚­ãƒ£ãƒ³å‡¦ç† ========
function scanLoop() {
    if (!scanning || detected) return;

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    const f = scanFrame.getBoundingClientRect();
    const v = video.getBoundingClientRect();

    canvas.width = f.width;
    canvas.height = f.height;

    const sx = (f.left - v.left) * (video.videoWidth / v.width);
    const sy = (f.top - v.top) * (video.videoHeight / v.height);
    const sw = f.width * (video.videoWidth / v.width);
    const sh = f.height * (video.videoHeight / v.height);

    ctx.drawImage(video, sx, sy, sw, sh, 0, 0, canvas.width, canvas.height);

    reader.decodeFromCanvas(canvas).then(result => processScan(result.text))
    .catch(() => requestAnimationFrame(scanLoop));
}

function processScan(code) {
    if (detected) return;
    detected = true;
    readSound.play();
    stopCamera();

    const ok = code.includes(firstInput);

    setStatus(ok ? "âœ” ä¸€è‡´ã—ã¾ã—ãŸï¼" : `âŒ ä¸ä¸€è‡´ï¼š${code}`, ok ? "ok" : "ng");
    ok ? successSound.play() : errorSound.play();

    saveResult(firstInput, code, ok ? "OK" : "NG");
    loadHistory();
}

// ======== å…¥åŠ›æ¤œçŸ¥ ========
document.getElementById("manualInput").addEventListener("change", () => {
    firstInput = manualInput.value.trim();
    if (firstInput) setStatus("æ¬¡ã«QRã‚’èª­ã¿å–ã£ã¦ãã ã•ã„", "normal");
});

// ======== DBä¿å­˜ ========
function saveResult(first, second, result) {
    const tx = db.transaction("checks", "readwrite");
    tx.objectStore("checks").add({
        time: new Date().toLocaleString(),
        first, second, result
    });
}

// ======== å±¥æ­´è¡¨ç¤º ========
function loadHistory() {
    const tx = db.transaction("checks", "readonly");
    const req = tx.objectStore("checks").getAll();

    req.onsuccess = () => {
        const table = document.getElementById("history");
        table.innerHTML = `<tr><th>æ™‚åˆ»</th><th>æ‰‹å…¥åŠ›</th><th>QR</th><th>çµæœ</th></tr>`;
        req.result.reverse().slice(0,15).forEach(r => {
            table.innerHTML += `<tr><td>${r.time}</td><td>${r.first}</td><td>${r.second}</td><td>${r.result}</td></tr>`;
        });
    };
}

// ======== CSVå‡ºåŠ› ========
document.getElementById("exportBtn").addEventListener("click", () => {
    const tx = db.transaction("checks", "readonly");
    const req = tx.objectStore("checks").getAll();

    req.onsuccess = () => {
        const rows = [["æ™‚åˆ»","å…¥åŠ›å€¤","QRå€¤","çµæœ"], ...req.result.map(r => [r.time,r.first,r.second,r.result])];
        const blob = new Blob([rows.map(r => r.join(",")).join("\n")], { type:"text/csv" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "æ¤œå“å±¥æ­´.csv";
        a.click();
    };
});

// ======== ãƒœã‚¿ãƒ³ ========
document.getElementById("startScanBtn").addEventListener("click", startScan);
document.getElementById("resetBtn").addEventListener("click", () => location.reload());
</script>
</body>
</html>
