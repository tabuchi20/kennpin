<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>QRæ¤œå“ï¼ˆiPhone + æ‰‹å‹•ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¯¾å¿œï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: -apple-system, BlinkMacSystemFont; padding: 20px; }
#status { padding: 20px; font-size: 22px; font-weight: bold; border-radius: 10px; text-align: center; margin-bottom: 20px; }
.ok { background: green; color: white; }
.ng { background: red; color: white; }
.normal { background: #e8e8e8; color: #003366; }
input { width: 100%; font-size: 24px; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 2px solid #888; }
button { width: 100%; font-size: 20px; padding: 15px; margin-top: 10px; border-radius: 10px; }

#video-container { position: relative; width: 100%; max-width: 400px; margin: auto; }
video { width: 100%; border-radius: 10px; }

#scan-frame {
    width: 220px; height: 220px;
    border: 3px solid rgba(255,0,0,0.8);
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
    border-radius: 10px;
}

#zoomControl {
    width: 100%;
    margin-top: 10px;
    margin-bottom: 20px;
}
</style>
</head>
<body>

<h2>ğŸ“¦ QRæ¤œå“ã‚·ã‚¹ãƒ†ãƒ ï¼ˆiPhoneå¯¾å¿œ + ãƒ•ã‚©ãƒ¼ã‚«ã‚¹èª¿æ•´ï¼‰</h2>

<div id="status" class="normal">1å›ç›®ã®ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>

<input id="manualInput" type="text" placeholder="ä¾‹ï¼š1234567890" autofocus maxlength="30">

<div id="video-container">
    <video id="camera" autoplay playsinline></video>
    <div id="scan-frame"></div>
</div>

<label>ğŸ”ã‚ºãƒ¼ãƒ èª¿æ•´ï¼š</label>
<input type="range" id="zoomControl" min="1" max="5" step="0.1" value="2">

<button id="startScanBtn">ğŸ“· 2å›ç›® QRèª­ã¿å–ã‚Šé–‹å§‹</button>
<button id="resetBtn">ãƒªã‚»ãƒƒãƒˆ</button>
<button id="exportBtn">CSVå‡ºåŠ›</button>

<h3>å±¥æ­´</h3>
<table id="history"></table>

<script src="https://unpkg.com/@zxing/library@latest"></script>

<script>
// ======== Safari Polyfill ========
if (!navigator.mediaDevices) navigator.mediaDevices = {};
if (!navigator.mediaDevices.getUserMedia) {
    navigator.mediaDevices.getUserMedia = function(c) {
        const getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
        if (!getUserMedia) return Promise.reject("éå¯¾å¿œ");
        return new Promise((res,rej)=>getUserMedia.call(navigator,c,res,rej));
    };
}

// ======== å¤‰æ•°ç®¡ç† ========
let firstInput = "";
let scanning = false;
let detected = false;
let currentTrack = null;

const reader = new ZXing.BrowserMultiFormatReader();

const readSound = new Audio("sounds/yomitori.mp3");
const successSound = new Audio("sounds/seikou.mp3");
const errorSound = new Audio("sounds/keikoku.mp3");

// ======== IndexedDB ========
let db;
const req = indexedDB.open("checksDB_manual", 1);
req.onupgradeneeded = e => {
    db = e.target.result;
    db.createObjectStore("checks", { keyPath: "id", autoIncrement: true });
};
req.onsuccess = e => {
    db = e.target.result;
    loadHistory();
};

// ======== UI ========
const statusBox = document.getElementById("status");
function setStatus(txt, type="normal") {
    statusBox.textContent = txt;
    statusBox.className = type;
}

const video = document.getElementById("camera");
const scanFrame = document.getElementById("scan-frame");
const zoomSlider = document.getElementById("zoomControl");

// ======== ã‚«ãƒ¡ãƒ©èµ·å‹• ========
async function startScan() {
    if (!firstInput) return alert("å…ˆã«ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

    scanning = true;
    detected = false;

    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video:{
                facingMode:"environment",
                width:{ideal:1920}, height:{ideal:1080},
                focusMode:"continuous",
                advanced:[{focusMode:"continuous"}]
            }
        });

        video.srcObject = stream;
        currentTrack = stream.getVideoTracks()[0];

        applyZoom(2);

        setStatus("ğŸ“Œ QRã‚³ãƒ¼ãƒ‰ã‚’æ ã«åˆã‚ã›ã¦ãã ã•ã„");
        requestAnimationFrame(scanLoop);

    } catch(err) {
        stopCamera();
        alert("ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: " + err.message);
    }
}

function stopCamera() {
    if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
    scanning = false;
}

// ======== ã‚¹ã‚­ãƒ£ãƒ³å‡¦ç† ========
function scanLoop() {
    if (!scanning || detected) return;

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    const f = scanFrame.getBoundingClientRect();
    const v = video.getBoundingClientRect();

    canvas.width = f.width;
    canvas.height = f.height;

    ctx.drawImage(video,
        (f.left - v.left) * (video.videoWidth/v.width),
        (f.top - v.top) * (video.videoHeight/v.height),
        f.width * (video.videoWidth/v.width),
        f.height * (video.videoHeight/v.height),
        0,0,canvas.width,canvas.height
    );

    reader.decodeFromCanvas(canvas)
        .then(result=>processScan(result.text))
        .catch(()=>requestAnimationFrame(scanLoop));
}

function processScan(code){
    detected = true;
    readSound.play();
    stopCamera();

    const ok = code.includes(firstInput);
    setStatus(ok?"âœ” ä¸€è‡´ã—ã¾ã—ãŸï¼":"âŒ ä¸ä¸€è‡´: "+code, ok?"ok":"ng");
    ok ? successSound.play() : errorSound.play();

    saveResult(firstInput, code, ok?"OK":"NG");
    loadHistory();
}

// ======== å…¥åŠ›æ¤œçŸ¥ ========
document.getElementById("manualInput").addEventListener("change", ()=>{
    firstInput = manualInput.value.trim();
    if(firstInput) setStatus("æ¬¡ã«QRã‚’èª­ã¿å–ã£ã¦ãã ã•ã„");
});

// ======== DBä¿å­˜ ========
function saveResult(a,b,c){
    db.transaction("checks","readwrite").objectStore("checks")
    .add({time:new Date().toLocaleString(), first:a, second:b, result:c});
}

// ======== å±¥æ­´ ========
function loadHistory(){
    const req = db.transaction("checks","readonly").objectStore("checks").getAll();
    req.onsuccess = ()=>{
        const table = document.getElementById("history");
        table.innerHTML = `<tr><th>æ™‚åˆ»</th><th>å…¥åŠ›</th><th>QR</th><th>çµæœ</th></tr>`;
        req.result.reverse().slice(0,20).forEach(r=>{
            table.innerHTML += `<tr><td>${r.time}</td><td>${r.first}</td><td>${r.second}</td><td>${r.result}</td></tr>`;
        });
    };
}

// ======== CSVå‡ºåŠ› ========
document.getElementById("exportBtn").onclick = ()=>{
    db.transaction("checks","readonly").objectStore("checks").getAll().onsuccess = e=>{
        const rows=[
            ["æ™‚åˆ»","å…¥åŠ›","QR","çµæœ"],
            ...e.result.map(r=>[r.time,r.first,r.second,r.result])
        ];
        const blob=new Blob([rows.map(r=>r.join(",")).join("\n")]);
        const a=document.createElement("a");
        a.href=URL.createObjectURL(blob);
        a.download="æ¤œå“å±¥æ­´.csv";
        a.click();
    };
};

// ======== æ‰‹å‹•ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ ========
video.addEventListener("click", async ()=> {
    if (!currentTrack) return;
    const caps = currentTrack.getCapabilities();
    if (!caps.focusDistance) return;

    await currentTrack.applyConstraints({ advanced:[{focusMode:"manual", focusDistance:caps.focusDistance.min}] });
    setStatus("ğŸ”§ ãƒ•ã‚©ãƒ¼ã‚«ã‚¹èª¿æ•´ä¸­...");
    setTimeout(()=>setStatus("ğŸ“Œ QRã‚³ãƒ¼ãƒ‰ã‚’æ ã«åˆã‚ã›ã¦ãã ã•ã„"),1000);
});

// ======== ã‚ºãƒ¼ãƒ èª¿æ•´ ========
zoomSlider.oninput = ()=>applyZoom(zoomSlider.value);

function applyZoom(level){
    if (!currentTrack) return;
    const caps = currentTrack.getCapabilities();
    if (caps.zoom) currentTrack.applyConstraints({ advanced:[{zoom:Number(level)}] });
}

// ======== ãƒœã‚¿ãƒ³ ========
document.getElementById("startScanBtn").onclick = startScan;
document.getElementById("resetBtn").onclick = ()=>location.reload();
</script>

</body>
</html>
